Desvendando o Select DinÃ¢mico
Autor: Mauricio Cruz
Data: 20/12/2010 11:47

Qual programador nunca se deparou com aquela regra funcional complicada (ou chata), que faz vocÃª ter que selecionar um monte de
tabelas quase iguais
, todas com o mesmo campo e com clÃ¡usula where parecidas?
Antes vocÃª sofria, mas depois desse post vocÃª
nÃ£o deverÃ¡ sofrer mais!
(claro, sempre tem aquele nego chato que curte um CTRL+C CTRL+V, mas beleza, cada um na sua!).
Report com exemplo de como montar
selects dinÃ¢micos
:
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“
REPORT zselect_dinamico.

* DeclaraÃ§Ãµes
*---------------------------------
DATA: fieldcat    TYPE lvc_t_fcat,
 r_fieldcat  LIKE LINE OF fieldcat,
 d_reference TYPE REF TO data.

FIELD-SYMBOLS: <table> TYPE STANDARD TABLE,
               <wa_table> TYPE ANY.

TYPES: BEGIN OF ty_select,
 line TYPE fieldname,
 END OF ty_select.

DATA: t_campos TYPE TABLE OF ty_select WITH HEADER LINE,
 t_tables TYPE TABLE OF ty_select WITH HEADER LINE,
 t_where  TYPE TABLE OF ty_select WITH HEADER LINE.

* CriaÃ§Ã£o do Fieldcat para Tabela DinÃ¢mica
*-----------------------------------------
r_fieldcat-fieldname = 'KUNNR'.
r_fieldcat-ref_field = 'KUNNR'.
r_fieldcat-ref_table  = 'KNA1'.
APPEND r_fieldcat TO fieldcat.

r_fieldcat-fieldname = 'NAME1'.
r_fieldcat-ref_field = 'NAME1'.
r_fieldcat-ref_table  = 'KNA1'.
APPEND r_fieldcat TO fieldcat.

* MÃ©todo EstÃ¡tico que cria a tabela interna do tipo do fieldcat
* Esse mÃ©todo estÃ¡ sendo "emprestado" da classe de ALV, sÃ³ para
* a montagem da tabela interna de maneira dinÃ¢mica
*----------------------------------------------------------------
CALL METHOD cl_alv_table_create=>create_dynamic_table
 EXPORTING
 it_fieldcatalog = fieldcat
 IMPORTING
 ep_table        = d_reference.

* A variÃ¡vel d_reference Ã© do tipo DATA
* Associa a referÃªncia da tabela, para ser possivel alterar os dados.
*--------------------------------------------------------------------
ASSIGN d_reference->* TO <table>.

* Monta tabela com os Campos que serÃ£o selecionados
*--------------------------------------------------
LOOP AT fieldcat INTO r_fieldcat  .
 t_campos-line = r_fieldcat-fieldname.
 APPEND t_campos.
ENDLOOP.

* Tabela onde serÃ¡ feito o Select
*---------------------------------
t_tables-line = 'KNA1'.

* ClÃ¡usula Where do Select
*-----------------------------------
t_where-line = 'KUNNR = ''0000006251'' OR'.
APPEND t_where.
t_where-line = 'LAND1 = ''CL'' '.
APPEND t_where.

* Select Totalmente DinÃ¢mico! :)
*---------------------------------
SELECT (t_campos)
 INTO TABLE <table>
 FROM (t_tables-line)
 WHERE (t_where).

* Divirta-se vendo os dados nos field-symbols
*------------------------------------------
LOOP AT <table> ASSIGNING <wa_table>.

 BREAK-POINT.

ENDLOOP.

BREAK-POINT.
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“
Um ponto importante Ã© lembrar que a montagem de selects dinÃ¢micos, em alguns poucos casos, prejudica a performance do programa (normalmente em selects
monstros
). Eu nÃ£o acreditava muito nisso atÃ© fazer testes massivos de comparaÃ§Ã£o de cÃ³digos e encontrar alguns problemas. Mas fique tranquilo, porque normalmente coisas dinÃ¢micas quebram o seu galho e nÃ£o atrapalham em nada!
Utilize o cÃ³digo acima pra
consulta
ou mesmo
copie e cole num programa local
para ver como funciona. Se vocÃª quiser, pode trocar as tabelas, os campos, a clÃ¡usula whereâ€¦ ğŸ˜€
AbraÃ§os!



ComentÃ¡rios:
Rafael Castro Melo (17/07/2014 11:28): Bom dia, Muito show o abap zombieâ€¦ preciso de ajudaâ€¦ tenho experiÃªncia em desenvolvimento em advpl-Totvs e estou iniciando no abap, porÃ©m estou com uma dÃºvidaâ€¦ preciso somar o valor de duas colunas no select select (data_emissao + cond_pgto) as data_vencimento from tabela como eu posso fazer isso? Atenciosamente Rafael Castro Melo
  Mauricio Cruz (22/07/2014 09:38): NÃ£o dÃ¡ direto no SELECT Rafael. VocÃª vai ter que trazer para o programa, e somar as colunas direto na tabela interna. ABs!
  Mauricio Cruz (22/07/2014 09:38): NÃ£o dÃ¡ direto no SELECT Rafael. VocÃª vai ter que trazer para o programa, e somar as colunas direto na tabela interna. ABs!
Paulo Sales (05/12/2012 13:28): Muito bom! ParabÃ©ns pelo post. Este site para mim Ã© o melhor aqui do Brasaâ€¦
  Mauricio Cruz (05/12/2012 14:24): Obrigado Paulo, que bom que vocÃª curte nosso trabalho ğŸ™‚ AbraÃ§os!
  Mauricio Cruz (05/12/2012 14:24): Obrigado Paulo, que bom que vocÃª curte nosso trabalho ğŸ™‚ AbraÃ§os!
cristovao sousa (29/10/2012 13:38): OlÃ¡ .. TEm como colocar a clausula â€ for all entries in â€  dinamicamente no select ? estou tentando implementar o cÃ³digo abaixo.. mais nÃ£o ta dando certo, tem alguma dica ? SELECT (g_selfields_tab) INTO TABLE FROM (pv_tabla) FOR ALL ENTRIES IN (tg_filtro) WHERE (gt_where).
  Mauricio Cruz (29/10/2012 13:47): Essa eu acho que eu sei ğŸ™‚ Tente colocar o FOR ALL ENTRIES t_tabela na variÃ¡vel que vocÃª colocar dinÃ¢micamente no FROM. No seu exemplo,  a string â€œPV_TABELAâ€ teria que ter nÃ£o sÃ³ a tabela do from, mas tambÃ©m o for all entries. PV_TABELA = 'MARA FOR ALL ENTRIES IN T_FAE'. E daÃ­ vocÃª complementa as variÃ¡veis do where c/ as igualdades para T_FAE, como num for all entries normal. Acho que Ã© isso, tente aÃ­ e depois nos conte se deu certo. Abs!
    cristovao sousa (29/10/2012 14:06): Consegui fazer assim : *   executa o select com a clausula FOR ALL ENTRIES. SELECT (g_selfields_tab) INTO TABLE FROM (pv_tabla) FOR ALL ENTRIES IN WHERE (gt_where). A minha dificuldade agora .. Ã© mover a tabela interna que contem as linhas que quero usar no for all entries in, para o FIELD-SYMBOLS Como movo esses valores ?
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
    cristovao sousa (29/10/2012 14:06): Consegui fazer assim : *   executa o select com a clausula FOR ALL ENTRIES. SELECT (g_selfields_tab) INTO TABLE FROM (pv_tabla) FOR ALL ENTRIES IN WHERE (gt_where). A minha dificuldade agora .. Ã© mover a tabela interna que contem as linhas que quero usar no for all entries in, para o FIELD-SYMBOLS Como movo esses valores ?
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
  Mauricio Cruz (29/10/2012 13:47): Essa eu acho que eu sei ğŸ™‚ Tente colocar o FOR ALL ENTRIES t_tabela na variÃ¡vel que vocÃª colocar dinÃ¢micamente no FROM. No seu exemplo,  a string â€œPV_TABELAâ€ teria que ter nÃ£o sÃ³ a tabela do from, mas tambÃ©m o for all entries. PV_TABELA = 'MARA FOR ALL ENTRIES IN T_FAE'. E daÃ­ vocÃª complementa as variÃ¡veis do where c/ as igualdades para T_FAE, como num for all entries normal. Acho que Ã© isso, tente aÃ­ e depois nos conte se deu certo. Abs!
    cristovao sousa (29/10/2012 14:06): Consegui fazer assim : *   executa o select com a clausula FOR ALL ENTRIES. SELECT (g_selfields_tab) INTO TABLE FROM (pv_tabla) FOR ALL ENTRIES IN WHERE (gt_where). A minha dificuldade agora .. Ã© mover a tabela interna que contem as linhas que quero usar no for all entries in, para o FIELD-SYMBOLS Como movo esses valores ?
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
    cristovao sousa (29/10/2012 14:06): Consegui fazer assim : *   executa o select com a clausula FOR ALL ENTRIES. SELECT (g_selfields_tab) INTO TABLE FROM (pv_tabla) FOR ALL ENTRIES IN WHERE (gt_where). A minha dificuldade agora .. Ã© mover a tabela interna que contem as linhas que quero usar no for all entries in, para o FIELD-SYMBOLS Como movo esses valores ?
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
      Mauricio Cruz (30/10/2012 07:18): SÃ³ pra constar, se vocÃª escreveu o FOR ALL ENTRIES no select, ele deixa de ser completamente dinÃ¢mico. Se hora o programa tiver que executar sem for all entries, e hora tiver que executar com o for all entries, vocÃª vai ter que escrever duas vezes o select. E o pior: para vocÃª conseguir fazer esse FOR ALL ENTRIES que vocÃª quer, c/ o Field-Symbol, obrigatoriamente seu Field-Symbol vai ter que referenciar o tipo da tabela do FOR ALL ENTRIES (a que vocÃª daria o ASSIGN). Se vocÃª nÃ£o fizer isso, nÃ£o vai compilar, porque o WHERE pede que vocÃª especifique o campo do FOR ALL ENTRIES (ex.: WHERE mara IN t_fae-mara). Dependendo do seu requerimento, vocÃª pode pesquisar sobre GENERATE SUBROTINE POOL. NÃ£o dÃ¡ pra explicar isso aqui, mas vocÃª consegue vÃ¡rios exemplos na internet. Abs!
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
        Mauricio Cruz (28/11/2012 10:37): Update: fiz um post sobre isso ğŸ˜€ http://www.abapzombie.com/dicas-abap/2012/11/28/gerando-e-executando-codigos-em-tempo-de-execucao/
Mauro Laranjeira (28/09/2011 14:09): Certo Mauricio, Pra ajudar um brother fiz um esquema bem parecido de select dinÃ¢mico, mas sem a clausula where. Creio que sÃ³ ira acrescentar, segue abaixo: FIELD-SYMBOLS: <fs_tabela> TYPE STANDARD TABLE.

DATA: tl_tabela TYPE REF TO data.
DATA: vl_tabela TYPE string VALUE 'MARA'.


CREATE DATA tl_tabela TYPE TABLE OF (vl_tabela).

ASSIGN tl_tabela->* TO <fs_tabela>.

SELECT * UP TO 10 ROWS
  FROM (vl_tabela)
  INTO TABLE <fs_tabela>.

BREAK-POINT. Abs a todos =D Mauro Laranjeira
  Mauricio Cruz (28/09/2011 14:12): Seu exemplo Ã© legal porque, se a tabela interna tiver a mesma definiÃ§Ã£o de uma tabela standard, vocÃª consegue fazer direto com o CREATE DATA. Ã‰ nÃ³is mano Mauro!
  Mauricio Cruz (28/09/2011 14:12): Seu exemplo Ã© legal porque, se a tabela interna tiver a mesma definiÃ§Ã£o de uma tabela standard, vocÃª consegue fazer direto com o CREATE DATA. Ã‰ nÃ³is mano Mauro!
Renan William Alves (11/08/2011 18:43): Opa! O blog estÃ¡ Ã³timo! Sempre procuro material para ABAP em sites brazucas e Ã© muito difÃ­cil encontrar algo de qualidade, vocÃªs e o ABAP101 estÃ£o de parabÃ©ns ğŸ™‚ SÃ³ estou sentindo falta de uns botÃµes aqui no final do post para recomendar para os amigos! Vai lÃ¡ no painel do WP e busca um plugin de share pra resolver isso ğŸ˜€ AbraÃ§os
  Mauricio Cruz (01/09/2011 11:50): Apanhei um pouco porque nÃ£o sei nada de PHP, mas consegui, finalmente, arrumar o ponto que o Renan comentou ğŸ™‚ AbraÃ§os e valeu pela sugestÃ£o!
  Mauricio Cruz (01/09/2011 11:50): Apanhei um pouco porque nÃ£o sei nada de PHP, mas consegui, finalmente, arrumar o ponto que o Renan comentou ğŸ™‚ AbraÃ§os e valeu pela sugestÃ£o!