Fun√ß√£o or Not Fun√ß√£o? A pergunta que quase nunca √© feita!
Autor: Mauricio Cruz
Data: 23/09/2011 14:45

Uma constru√ß√£o comum no mundo do ABAP:
LOOP AT T_DADOS INTO LWA_DADOS.

  CALL FUNCTION 'BUSCA_INFORMACOES_ADICIONAIS'
    EXPORTING
      material   = lwa_dados-material
    TABLES
      t_details  = t_inf_aux.

  (...)

ENDLOOP.
Simples n√£o √©? Consideramos aqui que a fun√ß√£o ‚ÄòBUSCA_INFORMACOES_ADICIONAIS‚Äô √© uma fun√ß√£o standard, que vai trazer todas as informa√ß√µes adicionais que vamos precisar de uma material na tabela T_INF_AUX.
√â muito bom descobrir que tem uma fun√ß√£o standard que retorna todos os dados formatados exatamente do jeito que precisamos. E √© exatamente neste sentimento de ‚Äúfelicidade‚Äù
que mora o perigo
‚Ä¶ üòï
O grande problema em utilizarmos essas fun√ß√µes
‚Äúfaz-tudo‚Äù
dentro de LOOPs √© que a fun√ß√£o pode fazer milh√µes, ou melhor, bilh√µes, ou melhor, trilh√µes de sele√ß√µes e acessos ao banco e destro√ßar a performance do nosso programa. Ao longo desses anos trabalhando com ABAP eu tenho notado que poucas pessoas se preocupam em analisar o c√≥digo dentro da fun√ß√£o antes de sair utilizando a ‚Äúdanada‚Äù dentro de la√ßos com milh√µes de registros.
Ludibriado pela facilidade com que os dados chegam
mastigados
para seu programa, √© f√°cil dar um tiro no p√©: ou no seu, ou de algu√©m que algum dia vai ter que fazer uma an√°lise de performance no programa, que ent√£o deve rodar mais lento que o Barrichello na Williams esse ano. üòØ
Mas e a√≠, como resolver?
Infelizmente, n√£o tem uma ‚Äúregra‚Äù que pode ser aplicada: cada caso √© um caso. O ideal √© que voc√™ sempre verifique o que a fun√ß√£o faz antes de sair enfiando ela em tudo quanto √© LOOP do seu c√≥digo.
Certa vez eu fiz uma an√°lise de performance num programa gigantesco, e o √∫nico problema real do programa era que ele chamava uma fun√ß√£o para busca da lista t√©cnica do material diversas vezes sem motivo. Vou usar aqui no exemplo a CS_BOM_EXPLOSION, s√≥ para explicar:
* Exemplo de como o c√≥digo estava, os par√¢metros n√£o s√£o os reais
LOOP AT t_ekpo INTO lwa_ekpo.

CALL FUNCTION 'CS_BOM_EXPLOSION'
  EXPORTING
    matnr  = lwa_ekpo-matnr
  TABLES
    (tabelas de retorno c/ a lista)

ENDLOOP.
Al√©m da fun√ß√£o fazer diversos SELECTs em seu processamento, n√£o era necess√°rio chamar a fun√ß√£o tantas vezes, afinal, a tabela T_EKPO cont√©m itens de documentos de MM, e itens de diferentes documentos podem ter o
mesmo material
. Logo, a fun√ß√£o era chamada v√°rias vezes para o mesmo material, destruindo a performance do programa para buscar repetidamente a mesma informa√ß√£o.
No caso que eu ajudei a resolver, fizeram um controle para que a fun√ß√£o n√£o fosse executada duas vezes para o mesmo material, e isso melhorou a performance do programa em uns 70%. O ideal seria refazer as sele√ß√µes dentro do programa, fazendo acessos √∫nicos a cada uma das tabelas no banco, mas pelo tempo que t√≠nhamos seria invi√°vel (e viva o dilema do tempo em TI).
Chupinhar a l√≥gica dos selects da fun√ß√£o pode ser a solu√ß√£o
, ou vai me dizer que voc√™ nunca usou uma fun√ß√£o que retornava milh√µes de coisas quando voc√™ s√≥ precisava de um flag? üòâ
Bom,
este √© s√≥ um exemplo
, mas a minha recomenda√ß√£o √© a de que voc√™s n√£o sejam ludibriados pela facilidade do retorno das informa√ß√µes e sempre tenham uma no√ß√£o dos acessos que a fun√ß√£o faz. Ou pelo menos d√° uma fu√ßada no google, vai que algu√©m j√° sofreu com ela üôÇ
Abra√ßos e
‚Äúbeware of the unholy function‚Äù
üëø



Coment√°rios:
Mario Eiji Morishita (27/10/2016 15:23): Pessoal, gostaria de uma ajuda, estou criando um relatorio de Lista Tecnica, aonde a TABELA STKO = Cabe√ßalho STPO = ITEM, estou usando a tabela MAST e STZU. Porem estou com um problema a Tabela STPO n√£o contem o Campo que relaciona a Lista Tenica Alternativa o que √© primordial para que posso encontrar os componentes da lista, alguem j√° passou por este problema. Forte Abra√ßo,
Mauro Laranjeira (26/09/2011 07:47): Grande Mauricio, Tamb√©m vale lembrar que existem fun√ß√µes que d√£o uma otimizada neste tipo de buscas, como por exemplo a fun√ß√£o KNA1_SINGLE_READ ou a MAKT_SINGLE_READ. Por conta do tratamento que a fun√ß√£o faz com o Buffer, muitas vezes compensa usar estas fun√ß√µes do que utilizar o select direto  üòØ Eu entendi que a id√©ia do post √© de n√£o utilizar fun√ß√µes que fazem 1000 coisas sendo que vc ira utilizar apenas uma informa√ß√£o. Abs, Mauro Laranjeira