Criando/Alterando tabela ordenadas (ou ‚Äúmanha‚Äù do BINARY SEARCH)
Autor: Mauricio Cruz
Data: 09/12/2011 09:00

Nos prim√≥rdios da minha vida como ABAPer, uma
s√°bia mestra ABAPai (pra rimar com JEDI, sacou? üôÑ
) me ensinou uma pequena t√°tica para que voc√™ consiga alterar ou criar tabelas ordenadas por uma chave qualquer. Recentemente, num curso de performance que ministrei, fiquei surpreso com o fato de que quase ningu√©m havia usado esse esquema em seus c√≥digos malucos.
Portanto, resolvi explicar e compatilhar essa dica aqui no ABAPZombie. Voc√™ pode usar para tabelas internas do tipo
STANDARD
.
Ent√£o vamos l√°! üòÄ
A id√©ia √© voc√™ se aproveitar do
algoritmo da busca bin√°ria
para descobrir o sy-tabix de onde o registro deveria estar.
Vamos supor que voc√™ tenha uma tabela com os dados:
num
1
2
3
5
Precisamos colocar o n√∫mero 4 em seu devido lugar!
Se voc√™ der um READ TABLE BINARY SEARCH na tabela acima, procurando pelo campo NUM = 4, o sistema vai retornar um SY-SUBRC = 4, por√©m o SY-TABIX ser√° preenchido com 4, que √© o lugar onde o registro de n√∫mero 4 deveria estar.
Da√≠ √© s√≥ inserir o danado ali para n√£o quebrar a ordena√ß√£o!
Vejam o exemplo:
REPORT zombie_manha_read_table.

* Types
TYPES: BEGIN OF ty_values,
        num TYPE numc5,
       END OF ty_values.

* Tables
DATA: t_desord TYPE TABLE OF ty_values,
      t_ord    TYPE TABLE OF ty_values.

* Work Areas
DATA: wa_val TYPE ty_values.

* Contador
DATA: v_count TYPE i.

*-- Vamos preencher a tabela com 10 linhas
DO 10 TIMES.
  ADD 1 TO v_count.
  wa_val-num = v_count.
  APPEND wa_val TO t_desord.
ENDDO.

* E agora, fazer com que os dados fiquem "desordenados" na T_DESORD
* ou seja, a ordena√ß√£o vai ficar inversa, do maior para o menor
* O output na sequencia ficaria 10, 9, 8, 7, 6...
SORT t_desord BY num DESCENDING.

*-- E agora, vamos fazer com que a tabela t_ord fique ordenada,
*-- sem usar o comando SORT
LOOP AT t_desord INTO wa_val.

* Nos aproveitamos do algoritmo de busca bin√°ria, que sempre
* retorna o SY-TABIX de onde o registro deveria ser inserido caso
* o mesmo n√£o exista!
  READ TABLE t_ord WITH KEY
    num = wa_val-num
  BINARY SEARCH
  TRANSPORTING NO FIELDS.

  IF sy-subrc <> 0.
*   Vamos inserir o danado onde ele deveria estar
    INSERT wa_val INTO t_ord INDEX sy-tabix.
  ENDIF.

ENDLOOP.

* E, magicamente, a ordena√ß√£o ficou correta na T_ORD!
* 1, 2, 3, 4, 5, 6..
No exemplo acima, voc√™ pode montar a tabela T_DESORD com qualquer ordena√ß√£o, que a tabela T_ORD vai sempre sair certinha. Pode testar üòâ
Bom, eu aprendi isso quando era um j√∫nior, e acho que por isso que eu sempre achei que ‚Äútodo mundo soubesse‚Äù. Enfim, pelo menos com esse post espero que mais pessoas saibam! üôÇ
Abra√ßos √† todos aqueles que curte ordena√ß√µes!



Coment√°rios:
Alexandre (20/06/2016 17:41): Fala Mauricio, obrigado pela dica. Bem que voc√™ podia ministrar esse curso de performance de forma online hein, para que pud√©ssemos ter a oportunidade de participar. Amadure√ßa essa ideia ai‚Ä¶. üôÇ
Alexandre (13/08/2014 10:51): Pessoal, Estou com uma d√∫vida, preciso fazer :  read TABLE it_files_in_dir with key name cp ‚Äò*.xml‚Äô into it_files O problema √© que n√£o sei como fazer um ‚ÄòLike‚Äô com read table
  Mauricio Cruz (15/08/2014 11:16): Sorry bro, vc n√£o vai conseguir fazer isso num read table, pq o sistema n√£o permite. S√≥ d√° para usar o ‚Äú=‚Äù em READ TABLEs. Abs!
  Mauricio Cruz (15/08/2014 11:16): Sorry bro, vc n√£o vai conseguir fazer isso num read table, pq o sistema n√£o permite. S√≥ d√° para usar o ‚Äú=‚Äù em READ TABLEs. Abs!
Custodio de Oliveira Antonio (12/12/2011 00:11): Complementando meu comentario anterior, fiz uns testes aqui para SORTED TABLE com 10, 1.000 e 10.000 registros, e usar INSERT   INTO TABLE  se mostrou aproximadamente 25% mais veloz. Abraco, Custodio
  Mauricio Cruz (12/12/2011 08:02): Ol√° Cust√≥dio, tudo bem? Obrigado pela coment√°rio! Realmente faz mais sentido usar o INSERT wa INTO TABLE itab, viajei e j√° estou arrumando. Mesmo para o caso onde o registro j√° exista (itab com UNIQUE KEY), o sistema retorna o SY-SUBRC = 4 e nos indica que o registro j√° foi inserido. J√° ajustei o c√≥digo. Ali√°s, vou fazer um post dedicado √† tabelas SORTED depois dessa üôÇ Abra√ßos!
  Mauricio Cruz (12/12/2011 08:02): Ol√° Cust√≥dio, tudo bem? Obrigado pela coment√°rio! Realmente faz mais sentido usar o INSERT wa INTO TABLE itab, viajei e j√° estou arrumando. Mesmo para o caso onde o registro j√° exista (itab com UNIQUE KEY), o sistema retorna o SY-SUBRC = 4 e nos indica que o registro j√° foi inserido. J√° ajustei o c√≥digo. Ali√°s, vou fazer um post dedicado √† tabelas SORTED depois dessa üôÇ Abra√ßos!
Custodio (11/12/2011 21:15): Boa dica para standard  tables, porem desnecessario para SORTED TABLES. Para esse tipo de tabela o comando INSERT faz o trabalho por voce, nao precisa especificar o indice: INSERT wa_val INTO TABLE t_ord. Abraco
Norberto Silva (10/12/2011 20:50): Mauricio, Parab√©ns pelo post. Excelente dica para quem est√° come√ßando e tamb√©m para quem j√° trabalha com ABAP, que resolvia esse problema de uma outra forma e n√£o conhecia essa possibilidade (como eu! rs). Obrigado, Norberto Silva
Rafael (09/12/2011 09:17): Bela dica Maur√≠cio, essa eu confesso que n√£o sabia, enfim, vivendo e aprendendo. Obrigado mais uma vez.
  Mauricio Cruz (09/12/2011 09:18): Normal! Como disse no post, eu meio que ‚Äúcresci‚Äù tendo essa l√≥gica bem clara na minha cabe√ßa, por isso que me espantei tanto quando algumas pessoas me disseram que n√£o sabiam. Mas normal, ningu√©m tem como saber tudo üôÇ Abra√ßos!
  Mauricio Cruz (09/12/2011 09:18): Normal! Como disse no post, eu meio que ‚Äúcresci‚Äù tendo essa l√≥gica bem clara na minha cabe√ßa, por isso que me espantei tanto quando algumas pessoas me disseram que n√£o sabiam. Mas normal, ningu√©m tem como saber tudo üôÇ Abra√ßos!