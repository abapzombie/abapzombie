Seguran√ßa ABAP ‚Äì Parte II ‚Äì Comunica√ß√£o com o kernel
Autor: Leo Schmidt
Data: 23/07/2012 14:00

Ol√° caros zumbis. Vamos continuar nossa (depressiva) caminhada pelas vulnerabilidades ABAP. Se voc√™ ainda n√£o leu o
white paper
que eu mencionei na Parte I,
essa √© sua chance
, porque agora vamos falar de comunica√ß√£o com o
kernel
.
CURIOSIDADE: certas ra√ßas de cachorro sabem latir em bin√°rio.
<MOMENTO_SOS_COMPUTADORES>
‚ÄúMAS QUE QUE √â ESSE QU√âRNEU?‚Äù
Kernel
√© o conjunto de programas e bibliotecas de fun√ß√µes principais/centrais de qualquer sistema, respons√°vel por fazer a ponte entre as aplica√ß√µes e os recursos do sistema operacional.
</MOMENTO_SOS_COMPUTADORES>
Se voc√™ j√° instalou/rodou alguma inst√¢ncia
trial
do Netweaver,
meus p√™sames
voc√™ j√° deve ter visto alguns dos arquivos que fazem parte do
kernel
do SAP:
disp+work
,
msg_server
,
sapcpe
,
strdbs
, entre outros.
O
kernel
do SAP √© escrito em C/C++, e certas fun√ß√µes das bibliotecas do
kernel
podem ser chamadas diretamente a partir de c√≥digo ABAP. Isso √© necess√°rio em momentos onde o c√≥digo ABAP n√£o consegue prover sozinho alguma determinada funcionalidade, tendo que recorrer ao sistema operacional/banco de dados/recursos de C ou C++. As chamadas de
kernel
a partir de ABAP podem ser feitas de tr√™s maneiras distintas:
kernel calls
,
system calls
e
kernel methods
.
Kernel calls
foram a primeira maneira criada dentro do ABAP para interagir com o
kernel
, e s√£o feitas atrav√©s do comando CALL ‚Äòfuncao_c‚Äô. No exemplo abaixo, a fun√ß√£o C_SAPGPARAM est√° retornando o valor do par√¢metro de perfil SAPDBHOST, que indica o
hostname
do banco de dados:
DATA v_value TYPE msxxlist-host.

CALL 'C_SAPGPARAM'
ID 'NAME'  FIELD 'SAPDBHOST'
ID 'VALUE' FIELD v_value.
Algumas peculiaridades das
kernel calls
:
Na vers√£o ECC 6.0 existem aproximadamente 370 fun√ß√µes dispon√≠veis para
kernel calls
, com um total de mais de 10.000 utiliza√ß√µes em c√≥digo standard;
O comando CALL ‚Äòfuncao_c‚Äô¬†√© considerado obsoleto, por√©m ainda funciona;
Apesar disso, n√£o h√° documenta√ß√£o (suficiente) para nenhuma das fun√ß√µes, e al√©m disso a documenta√ß√£o existente diz de maneira clara que essa t√©cnica n√£o deve ser usada fora do c√≥digo standard;
Como visto no exemplo, n√£o h√° nenhuma maneira de identificar quais s√£o os par√¢metros de entrada ou de sa√≠da, a n√£o ser analisando a pr√≥pria fun√ß√£o.
A
kernel call
mais conhecida √© (talvez)¬†a CALL ‚ÄòSYSTEM‚Äô, que √© usada para executar comandos no
shell
do SO hospedeiro do
application server
. A lista de comandos que podem ser executados √© controlada atrav√©s das transa√ß√µes SM49 / SM69.
‚ÄúAh, mas ent√£o eu posso escrever uma fun√ß√£o malandra em C/C++ e tocar o terror dentro do SAP?‚Äù N√ÉO, AMIZADE, VOC√ä N√ÉO PODE. A documenta√ß√£o diz que a sua fun√ß√£o teria que estar presente no
include
SAPACTAB.H e o
kernel
teria que ser recompilado. Vai explicar essa necessidade pro Basis.
Os outros tipos de chamadas que foram citadas ‚Äì
system calls
e
kernel methods
‚Äì tem o mesmo objetivo das
kernel calls
, por√©m s√£o realizadas de formas diferentes:
system calls
s√£o feitas a partir do comando SYSTEM-CALL, com sua pr√≥pria sintaxe (e que, segundo a documenta√ß√£o, s√≥ pode ser usado pela equipe de desenvolvimento Basis da pr√≥pria SAP) e
os
kernel methods
s√£o m√©todos implementados com a adi√ß√£o BY KERNEL MODULE¬†modulo_c, por√©m com a implementa√ß√£o vazia e chamando m√≥dulos registrados dentro do
include
ABKMETH.H.
Novamente, n√£o vou falar aqui de todas as vulnerabilidades ‚Äì mesmo porque isso demanda um estudo mais prolongado ‚Äì mas vou citar aqui as duas fun√ß√µes que o documento da VirtualForge classifica com risco
very high
, ou seja, ONDE O BICHO PEGA:
C_DB_EXECUTE:
CALL 'C_DB_EXECUTE'
ID 'STATLEN' FIELD lv_comprimento
ID 'STATTXT' FIELD lv_comando
ID 'SQLERR'  FIELD lv_erro.
Com exce√ß√£o de SELECTs, essa chamada pode executar
qualquer comando SQL diretamente no banco de dados
‚Äì incluindo todo tipo de DROP, ALTER, TRUNCATE, etc. Precisa dizer mais alguma coisa?
C_DB_FUNCTION:
* Chamando uma stored procedure

CALL 'C_DB_FUNCTION'
ID 'FUNCTION' FIELD 'DB_SQL'
ID 'FCODE'    FIELD 'EP'
ID 'PROCNAME' FIELD lv_nome_procedure
ID 'CONNAME'  FIELD lv_con_name
ID 'CONDA'    FIELD lv_conda
ID 'PARAMS'   FIELD lt_parametros
ID 'ROWCNT'   FIELD lv_contador_linhas
ID 'SQLCODE'  FIELD lv_sql_code
ID 'SQLMSG'   FIELD lv_sql_msg.

* Chamando uma fun√ß√£o

CALL 'C_DB_FUNCTION'
ID 'FUNCTION'    FIELD 'DB_SQL'
ID 'FCODE'       FIELD 'PO'
ID 'STMT_STR'    FIELD lv_comando
ID 'CONNAME'     FIELD lv_con_name
ID 'CONDA'       FIELD lv_con_da
ID 'HOLD_CURSOR' FIELD lv_cursor
ID 'INVALS'      FIELD lt_valores
ID 'CURSOR'      FIELD lv_cursor
ID 'SQLCODE'     FIELD lv_sql_code
ID 'SQLMSG'      FIELD lv_sql_msg.
N√£o bastasse a execu√ß√£o de comandos, com a C_DB_FUNCTION √© poss√≠vel tamb√©m chamar
stored procedures
e demais fun√ß√µes SQL dispon√≠veis no BD
. √â mole?
Pra colocar a cereja no bolo, essas duas chamadas
n√£o fazem nenhuma verifica√ß√£o de autoriza√ß√µes
.
Mais uma vez, entendo que fica evidente a mensagem aqui:
n√£o execute
kernel calls
diretamente
. Existem alternativas ‚Äúdentro da lei‚Äù para todas as chamadas, inclusive para a famigerada CALL ‚ÄòSYSTEM‚Äô ‚Äì d√° pra trocar pela fun√ß√£o¬†SXPG_COMMAND_EXECUTE.
Bom galera, isso era o que tinha de interessante dentro desse
white paper
da VirtualForge, mas ainda assim eu recomendo ler o resto do documento e tamb√©m o restante do material dispon√≠vel no
site deles
. Nem tudo tem a ver com seguran√ßa puramente em ABAP, mas √© material interessante de qualquer forma.
O assunto seguran√ßa em ABAP n√£o acaba por aqui: continuando a s√©rie, eu vou tentar falar sobre as bibliotecas
standard
que fazem coisas bacanas como prote√ß√£o contra v√≠rus e assinaturas digitais. At√© a pr√≥xima.



Coment√°rios:
Miguel Motta (26/11/2012 18:01): Pessoal, algu√©m sabe como vejo o fonte das fun√ß√µes da biblioteca SAPACTAB.H? Tenho quase certeza que meu problema est√° em umas dessas fun√ß√µes, gostaria de confirmar analisando o c√≥digo para abrir um chamado na SAP. Meu problema est√° neste m√©todo: method IF_SXML_READER~NEXT_NODE by kernel module fxkmsrd_next_node fail. endmethod. Da classe CL_SXML_READER Abra√ßos!
  ABAP da Depress√£o (27/11/2012 09:22): Cara, se voc√™ tem certeza que algum m√©todo standard com BY KERNEL MODULE est√° com erro, pode abrir direto o chamado na SAP dizendo somente isso, porque duvido que quem vai atender seu chamado v√° pedir pra voc√™ localizar o erro dentro de um include do kernel. []s
    Miguel Motta (27/11/2012 14:34): Foi isso que eu fiz! Vamos ver a resposta! Mas caso eu queira analisar as fun√ß√µes do kernel √© poss√≠vel?
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
    Miguel Motta (27/11/2012 14:34): Foi isso que eu fiz! Vamos ver a resposta! Mas caso eu queira analisar as fun√ß√µes do kernel √© poss√≠vel?
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
  ABAP da Depress√£o (27/11/2012 09:22): Cara, se voc√™ tem certeza que algum m√©todo standard com BY KERNEL MODULE est√° com erro, pode abrir direto o chamado na SAP dizendo somente isso, porque duvido que quem vai atender seu chamado v√° pedir pra voc√™ localizar o erro dentro de um include do kernel. []s
    Miguel Motta (27/11/2012 14:34): Foi isso que eu fiz! Vamos ver a resposta! Mas caso eu queira analisar as fun√ß√µes do kernel √© poss√≠vel?
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
    Miguel Motta (27/11/2012 14:34): Foi isso que eu fiz! Vamos ver a resposta! Mas caso eu queira analisar as fun√ß√µes do kernel √© poss√≠vel?
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
      ABAP da Depress√£o (27/03/2013 15:19): Desculpe o atraso de 4 meses, por√©m: n√£o, voc√™ n√£o pode.
Haroldo Doratiotto (21/08/2012 10:22): Comentando sobre o post do Diego Henrique Gomes. Como eu disse uma vez em outra discuss√£o, que era v√°lido o conhecimento em outras linguagens ou at√© mesmo um pouco de bando de dados‚Ä¶rsrsrs No PostgreSQL tem um comando chamado ILIKE. Ele retorna tanto mai√∫sculo quanto min√∫sculo. SELECT * FROM TABELA WHERE CAMPO ILIKE = ‚Äòa%‚Äô; Bom pessoal, n√£o tem nada a ver com o assunto de seguran√ßa, mas √© s√≥ porque lembrei desse comando quando li o post do nosso amigo. Abra√ßos‚Ä¶
Diego Henrique Gomes (16/08/2012 12:22): Lembrei de algo que fiz uma vez. Em uma tabela z, uma das colunas armazenava os campos com mai√∫sculo e minusculo. Por√©m depois de um tempo o usu√°rio queria buscar SAP e encontrar sap. N√£o sei se foi o melhor caminho, mas foi o √∫nico que pensei: executei direto no banco a busca. Era algo assim: EXEC SQL PERFORMING f_append_itab. SELECT * FROM Z_TABELA INTO :wa_Z_TABELA WHERE MANDT like :SY-MANDT upper(‚ÄúBNAME‚Äù) like :usr02-bname ENDEXEC. Acho que √© uma outra maneira, mas n√£o sei quanto a seguran√ßa, se fica algum log, faz alguma valida√ß√£o‚Ä¶ enfim, n√£o tentei fazer ‚Äúnada de mais‚Äù com o banco depois disso, mas penso as vezes se abre v√°rios leques.
  ABAP da Depress√£o (16/08/2012 20:33): O standard normalmente resolve esse problema adicionando uma coluna ‚Äúmatchcode‚Äù na tabela, onde o texto que precisa ser buscado √© gravado todo em mai√∫sculas. EXEC SQL nesse caso foi meio extremo üòÄ Ainda assim, se voc√™ estiver controlando a entrada do campo USR02-BNAME, a aplica√ß√£o n√£o vai ter problemas. EXEC SQL √© perigoso em geral porque abre espa√ßo pra usar qualquer comando de data definition , mas uma vez que est√° definido que somente o SELECT √© executado, o risco fica para o que for feito posteriormente com os dados da sua tabela Z.
    Diego Henrique Gomes (16/08/2012 22:41): Mas eu n√£o queria mudar os dados da tabela, da√≠ o check para gravar s√≥ mai√∫scula eu n√£o poderia marcar‚Ä¶  Neste caso acho que o risco fo√≠ minimo, mas teria alguma solu√ß√£o alternativa que n√£o fosse gravando os dados em mai√∫sculo? acho que pra fazer essa busca, s√≥ assim mesmo.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
    Diego Henrique Gomes (16/08/2012 22:41): Mas eu n√£o queria mudar os dados da tabela, da√≠ o check para gravar s√≥ mai√∫scula eu n√£o poderia marcar‚Ä¶  Neste caso acho que o risco fo√≠ minimo, mas teria alguma solu√ß√£o alternativa que n√£o fosse gravando os dados em mai√∫sculo? acho que pra fazer essa busca, s√≥ assim mesmo.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
  ABAP da Depress√£o (16/08/2012 20:33): O standard normalmente resolve esse problema adicionando uma coluna ‚Äúmatchcode‚Äù na tabela, onde o texto que precisa ser buscado √© gravado todo em mai√∫sculas. EXEC SQL nesse caso foi meio extremo üòÄ Ainda assim, se voc√™ estiver controlando a entrada do campo USR02-BNAME, a aplica√ß√£o n√£o vai ter problemas. EXEC SQL √© perigoso em geral porque abre espa√ßo pra usar qualquer comando de data definition , mas uma vez que est√° definido que somente o SELECT √© executado, o risco fica para o que for feito posteriormente com os dados da sua tabela Z.
    Diego Henrique Gomes (16/08/2012 22:41): Mas eu n√£o queria mudar os dados da tabela, da√≠ o check para gravar s√≥ mai√∫scula eu n√£o poderia marcar‚Ä¶  Neste caso acho que o risco fo√≠ minimo, mas teria alguma solu√ß√£o alternativa que n√£o fosse gravando os dados em mai√∫sculo? acho que pra fazer essa busca, s√≥ assim mesmo.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
    Diego Henrique Gomes (16/08/2012 22:41): Mas eu n√£o queria mudar os dados da tabela, da√≠ o check para gravar s√≥ mai√∫scula eu n√£o poderia marcar‚Ä¶  Neste caso acho que o risco fo√≠ minimo, mas teria alguma solu√ß√£o alternativa que n√£o fosse gravando os dados em mai√∫sculo? acho que pra fazer essa busca, s√≥ assim mesmo.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
      ABAP da Depress√£o (16/08/2012 23:02): Acho que n√£o ficou claro, mas o que eu quis dizer √© que a coluna matchcode √© uma c√≥pia da coluna com capitaliza√ß√£o alternada, s√≥ que com o texto em mai√∫sculas. Mesmo assim, sem mudar a estrutura da tabela o jeito √© usar mesmo Native SQL como vc fez, porque o OpenSQL infelizmente tem essas limita√ß√µes.
Felipe Tieppo (24/07/2012 15:48): Parab√©ns! Estou aguardando o pr√≥ximo post.
Mauricio Cruz (23/07/2012 16:18): Muito bom o post, parab√©ns!