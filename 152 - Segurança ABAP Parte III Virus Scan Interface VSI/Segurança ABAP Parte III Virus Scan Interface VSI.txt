Seguran√ßa ABAP ‚Äì Parte III ‚Äì Virus Scan Interface (VSI)
Autor: Leo Schmidt
Data: 22/08/2012 10:00

Fala, bando de morto-vivo! Admito que demorei, mas estou aqui de volta pra seguir esta s√©rie. Pois bem, com o assunto ‚Äúvulnerabilidades ABAP‚Äù esgotado, desta vez vou falar um pouco sobre a interface que d√° suporte √† prote√ß√£o contra v√≠rus do SAP, a
Virus Scan Interface
(VSI).
AS DEFINI√á√ïES DE V√çRUS FORAM IGNORADAS
‚ÄúO QUE? O SAP TEM ANTI-V√çRUS?‚Äù
Na verdade n√£o tem. O que vem instalado no SAP √© apenas uma interface, chamada
NetWeaver Virus Scan Interface
(NW-VSI)
, que faz o meio de campo entre c√≥digo ABAP ou Java e o programa anti-v√≠rus de verdade. O programa anti-v√≠rus espec√≠fico deve ser escolhido pelo cliente e √© fornecido por parceiros certificados da SAP.
A maior parte do trabalho aqui fica com o Basis, que tem que instalar o
servidor de anti-v√≠rus e fazer todas as configura√ß√µes correspondentes. Uma vez que tudo esteja no lugar, a parte ABAP √© bem simples: basta verificar os arquivos usando os m√©todos da classe CL_VSI, que como d√° pra ver abaixo, usa o padr√£o
singleton
.
* Busca inst√¢ncia do scanner
DATA: lo_scanner TYPE REF TO cl_vsi.

CALL METHOD cl_vsi=>get_instance
  EXPORTING
    if_profile         = '/MEU_PACOTE/MINHA_APLICACAO'
  IMPORTING
    eo_instance        = lo_scanner
  EXCEPTIONS
    profile_not_active = 1
    OTHERS             = 2.

CASE sy-subrc.
  WHEN 0.
* Tudo certo com a interface
  WHEN 1.
* O antiv√≠rus est√° desabilitado para a aplica√ß√£o /MEU_PACOTE/MINHA_APLICACAO.
* Aqui, a SAP recomenda exibir o erro com a mensagem da exce√ß√£o se o
* escaneamento anti-v√≠rus for obrigat√≥rio.
  WHEN OTHERS.
* Este caso √© sempre um erro, e a SAP tamb√©m recomenda que seja sempre usada
* a mensagem da exce√ß√£o.
ENDCASE.
O nome /MEU_PACOTE/MINHA_APLICACAO deve ser fornecido pelo Basis, que vai fazer a configura√ß√£o desse perfil na transa√ß√£o VSCANPROFILE. Com a inst√¢ncia da CL_VSI na m√£o, √© s√≥ chamar o m√©todo que faz o escaneamento e avaliar o retorno.
DATA: lv_scanrc TYPE vscan_scanrc,
      lv_data   TYPE xstring,
      lv_text   TYPE string.

* A vari√°vel LV_DATA aqui deve receber o conte√∫do do arquivo a ser escaneado

CALL METHOD lo_scanner->scan_bytes
  EXPORTING
    if_data             = lv_data
  IMPORTING
    ef_scanrc           = lv_scanrc
  EXCEPTIONS
    not_available       = 1
    configuration_error = 2
    internal_error      = 3
    OTHERS              = 4.

* Se o SY-SUBRC voltar diferente de 0 aqui, √© erro da VSI
IF sy-subrc <> 0.
* MESSAGE...
* EXIT.
ENDIF.

* Para cada valor de LV_SCANRC retornado pelo SCAN_BYTES, existe um texto
* correspondente que pode ser buscado com o GET_SCANRC_TEXT. Se voltar 0,
* nenhum v√≠rus
lv_text = cl_vsi=>get_scanrc_text( lv_scanrc ).

WRITE: / 'Resultado do escaneamento:',
       / 'Return code: ',              lv_scanrc,
       / 'Descri√ß√£o: ',                lv_text.
Al√©m do SCAN_BYTES, existem dentro da classe CL_VSI os m√©todos SCAN_FILE para escanear arquivos no
application server
, e tamb√©m o SCAN_ITAB, que escaneia uma tabela interna.
Eu particularmente nunca vi VSI ser aplicada em nenhum projeto/cliente, mas √© √≥bvio que pode ser algo √∫til. A pr√≥pria
documenta√ß√£o da SAP
sobre o assunto sugere que a VSI pode ser √∫til em aplica√ß√µes que envolvam o recebimento de arquivos externos de usu√°rios, como por exemplo uma interface de HR que recebe curr√≠culos de candidatos para uma sele√ß√£o atrav√©s da internet. √â claro que √© uma coisa que nem sempre vai ser usada, mas √© bacana saber que existe.
Tenho que assumir que esse foi um post meio enchedor de lingui√ßa, mas acontece que a chibata est√° cantando pro meu lado no trampo, ent√£o n√£o est√° muito f√°cil de parar e escrever. Na sequ√™ncia desta s√©rie, prometo falar de algo mais interessante que √© o suporte a criptografia e assinaturas digitais dentro do SAP. At√© l√°.



Coment√°rios:
Hector (14/05/2013 15:51): Bom post, pena que zombie n√£o consegue abrir foto da festa, pois ao inv√©s disso ele passa a noite debugando !!
Custodio (23/08/2012 00:08): Fui usar essa classe uma vez, o Dev Leader falou ‚Äúprecisa nao, ninguem vai ‚Äòupar‚Äô arquivo com virus‚Äù üòÄ
Mauricio Cruz (22/08/2012 13:05): Curti o post. Complementando o assunto com o que eu sei sobre VSI: por mais bizarro que possa parecer, eu tive contato com um time de indianos experts em seguran√ßa no SAP, e o guide dos caras era usar SEMPRE a VSI quando um prog ABAP tiver acesso a arquivos externos. Para eles, o esquema √© deixar tudo codificado, pra funcionar autom√°tico quando (se) o cliente implementar a VSI. Meio extremista, mas cada um faz o que quiser, falae üòõ