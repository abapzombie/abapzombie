Aplicando Query Services (e quebrando a cara)
Autor: Leo Schmidt
Data: 26/09/2012 10:00

Ol√°, zumbizada faminta por c√≥digo.
No ano passado, o F√°bio do ABAP101 fez
uma s√©rie de posts
explicando o que s√£o e como funcionam os
Object Services
(OS). Eu gostei da ideia, e como fui recentemente envolvido numa demanda de constru√ß√£o de relat√≥rios, achei que seria bacana aplicar o servi√ßo de
queries
para ver como ‚Äì e se ‚Äì funciona. Infelizmente, apanhei e n√£o gostei do resultado.
‚ÄúEle vai apanhar, vai apanhar muito. N√£o vai ter conversinha dessa vez‚Äù declarou Query Services em entrevista pol√™mica
O
help
da SAP
sobre este assunto √© fundamental para entender como funcionam as classes e os m√©todos relacionados a OS. Usando esse conhecimento e os exemplos que est√£o nos posts do ABAP101, √© poss√≠vel come√ßar a usar persist√™ncia no c√≥digo at√© com certa facilidade.
S√≥ que com essa mesma facilidade, os problemas come√ßam a ficar evidentes. O F√°bio j√°¬†¬†apontou algumas das desvantagens de se usar OS, mas algumas coisas s√≥ se encontra quando se tenta implementar, n√£o √© mesmo?
A persist√™ncia n√£o √© persistente
Uma das primeiras caracter√≠sticas dos OS mencionadas no
help
√© que
o servi√ßo de persist√™ncia n√£o √© realmente persistente, porque n√£o existe bloqueio de objetos transientes
. Isso significa que n√£o existe uma administra√ß√£o global de objetos dentro do servi√ßo de persist√™ncia; se, por exemplo, dois programas diferentes buscarem o mesmo objeto persistente ao mesmo tempo, cada programa ter√° a sua pr√≥pria vers√£o transiente em mem√≥ria at√© que um deles execute um COMMIT WORK.
Isso √©, sem falsa mod√©stia, inaceit√°vel. Fica a pergunta a ser feita para a SAP: qual √© a raz√£o por tr√°s disso?¬†Por qu√™ liberar uma API pela metade, s√≥ para que os desenvolvedores tenham o ‚Äúgostinho‚Äù de usar um conceito amplamente difundido h√° muito tempo em outras linguagens que usam OO? As ‚Äúmelhorias‚Äù¬†est√£o em planejamento, desenvolvimento ou foram abandonadas?
Atrito
desnecess√°rio
H√° alguns pequenos problemas espalhados nas classes de OS. Exemplos:
Os par√¢metros dos m√©todos da interface IF_OS_QUERY_EXPR_FACTORY (respons√°vel por criar filtros para as
queries
) s√≥ aceitam os valores como STRING;
Os filtros de
queries
n√£o s√£o compat√≠veis com OpenSQL, ent√£o ao cri√°-los n√£o √© poss√≠vel usar diretamente comparadores como IS INITIAL, IN, BETWEEN, etc.;
Ainda na interface¬†IF_OS_QUERY_EXPR_FACTORY, os m√©todos que criam filtros com base em outros filtros (CREATE_AND_EXPR, CREATE_OR_EXPR ou CREATE_NOT_EXPR) retornam a exce√ß√£o¬†CX_SY_REF_IS_INITIAL se um dos objetos estiver vazio. Isso √© um problema quando se est√° montando um filtro composto, como por exemplo quando se concatena os valores dos
ranges
de uma tela de sele√ß√£o e nem todos est√£o preenchidos;
O m√©todo GET_PERSISTENT da classe agente retorna a exce√ß√£o¬†CX_OS_OBJECT_NOT_FOUND se o registro n√£o for encontrado. Isso √© uma solu√ß√£o muito mais dr√°stica quando comparada ao OpenSQL, que nesse caso retornaria somente SY-SUBRC = 0 e a estrutura vazia, ou mesmo comparando com o m√©todo IF_OS_CA_PERSISTENCY~GET_PERSISTENT_BY_QUERY, que retornaria apenas uma tabela vazia;
N√£o √© poss√≠vel usar diretamente a tabela de retorno da
query
(tipo OSREFTAB) para uma outra sele√ß√£o, como num¬†FOR ALL ENTRIES, sem antes montar um filtro para a nova
query
.
Esses s√£o apenas exemplos, mas provavelmente a classe agente deve ter mais alguns problemas parecidos. √â claro que tudo isso pode ser contornado pelo desenvolvedor, que pode por exemplo criar um classe
helper
para encapsular a chamada desses m√©todos. Mas esses comportamentos poderiam muito bem ser mais suaves e amig√°veis, sem jogar exce√ß√µes pra todo lado e mais bem adaptados aos elementos de Dynpro (principalmente para o uso de
ranges
) que j√° est√£o em uso h√° muitos anos.
Falta de integra√ß√£o
Isso √© algo que o F√°bio j√° cita em seus
posts
, mas ao implementar √© que se percebe como a integra√ß√£o com outros elementos do SAP faz falta. Por exemplo, uma integra√ß√£o com o
Business Object Repository
(BOR) seria extremamente bem vinda para trazer/manipular dados de tabelas
standard
; em vez disso, somos obrigados a criar classes persistentes para cada tabela/vis√£o, ou at√© mesmo para cada utiliza√ß√£o diferente dos dados da tabela.
Performance
Tem gente que arrepia s√≥ de ouvir essa palavra, e com raz√£o. √â talvez o aspecto mais dif√≠cil de se controlar num programa ABAP. E √© triste informar que OS n√£o resolve esse problema.
Eu fiz um teste de performance com uma classe persistente Z para a tabela ANLC (Campos de valor do imobilizado). No ambiente em que eu fiz o teste, essa tabela tinha ~7.500.000 entradas, e eu informei como par√¢metros os campos BUKRS e GJAHR, de modo a restringir a sele√ß√£o a ~400.000 resultados. N√£o √© um volume muito grande, mas √© uma aproxima√ß√£o do que um relat√≥rio real teria que fazer.
O programa apenas seleciona os dados de todos os campos da tabela usando OpenSQL ou OS, dependendo da escolha na tela de sele√ß√£o. Com este programa, eu fiz dois testes: um rodando em
background
duas vezes, uma vez usando OpenSQL e outra usando OS, e depois executei a an√°lise
on-line
da transa√ß√£o SAT, tamb√©m com uma op√ß√£o de cada vez. Eis os resultados:
Resultado dos jobs do programa teste (clique para ver maior)
Resultados da an√°lise SAT usando OpenSQL (clique para ver maior)
Resultados da an√°lise SAT usando Query Services (clique para ver maior)
Analisando os resultados:
O programa, ao usar OS, demora o dobro do tempo para trazer a mesma quantidade de dados comparado com o uso de OpenSQL (a an√°lise SAT mostra que √© quase o triplo, por√©m o tempo da SAT pode ser maior por causa do servidor usado para o teste);
O tempo de sele√ß√£o dos dados √© quase o mesmo nos dois casos (ligeiramente maior usando OS), porque no fundo ambas as situa√ß√µes est√£o usando SELECT, sendo que a diferen√ßa √© que o SELECT usado na classe agente √© din√¢mico;
O tempo extra se deve √†s chamadas da classe base e das classes auxiliares de OS, que s√£o feitas em 18 pontos distintos e executadas uma vez para cada registro (lembrando que o m√©todo chamado aqui √© o¬†IF_OS_CA_PERSISTENCY~GET_PERSISTENT_BY_QUERY).
Eu repeti os mesmos testes apenas omitindo o valor do par√¢metro GJAHR, o que resultaria em ~2.000.000 resultados. Executando o programa com essa sele√ß√£o e usando OS, a execu√ß√£o resultou em
dump
por falta de mem√≥ria tanto rodando em
background
como
on-line
, enquanto a execu√ß√£o com OpenSQL respondeu normalmente nos dois modos.
Conclus√£o
OS √© pra se jogar fora? Ainda n√£o. A implementa√ß√£o pode ser meio r√≠spida, mas √© uma t√©cnica que funcionaria bem para controlar, por exemplo, um cadastro com um volume de pequeno a m√©dio (~500.000 registros, talvez) baseado em tabelas Z.
Mesmo assim, eu confesso que fiquei desapontado com esses resultados.¬†√â ruim constatar que OS tem todos esses problemas, principalmente porque esse conceito seria essencial para alavancar o uso de OO dentro do ABAP. √â mais f√°cil enxergar OO quando cada registro ou conjunto de registros √© representado por uma classe que tem a sua pr√≥pria l√≥gica, em vez de apenas serem um conjunto de dados em algumas tabelas. E¬†embora OpenSQL seja algo bom, e que tende a melhorar com a ado√ß√£o de tecnologias como HANA, ainda se trata de c√≥digo procedural.
E voc√™, concorda ou discorda? Acha que minhas conclus√µes est√£o furadas ou ficou decepcionado(a) tamb√©m? Esse assunto √© interessante e pode render muito, ent√£o sinta-se √† vontade para comentar.
[]s e at√© a pr√≥xima.



Coment√°rios:
Fl√°vio Furlan (02/11/2012 09:45): No SITSP eu at√© comentei com o Maur√≠cio sobre usar o ECC ter algo parecido com o BOL do CRM. Ser√° que o OS n√£o seria um ensaio de BOL dentro do ECC? Eu j√° tentei usar OS para relat√≥rios, mas ele acabou n√£o agregando muito. Eu acho que o OS foi pensando para os casos onde o programa precisa trabalhar com um objeto de neg√≥cio por vez, a exemplo das transa√ß√µes standards (VAs, VT, VLs etc.). Se for isso mesmo, o uso do OS fica muito limitado mesmo, pois √© raro esse caso de uso comparado com relat√≥rios, ou seja, geralmente a cada 13.0E23 relat√≥rios, voc√™ precisa fazer um programa on-line. Est√° certo a minha compara√ß√£o entre OS e BOL?
Nuno Godinho (28/09/2012 13:45): Ol√°! Embora tenha muita curiosidade para experimentar OS, continuava c√©ptico em rela√ß√£o √† performance. H√° uns tempos li o livro da SAP Press chamado Object Services e gostei, mas fiquei cheio de d√∫vidas e pouco convencido com algumas coisas. O teu artigo conclui o que eu j√° desconfiava: tem muitas falhas! √â esperar que a SAP corrija isto. A usar, s√≥ mesmo para a gest√£o de pouca quantidade de dados. E mesmo assim, a quest√£o dos bloqueios n√£o serem tratados pela API, porra!, √© uma vergonha. Outra coisa que falha: h√° 2 anos atr√°s considerei usar OS mas precisava que as classes OS fossem abstractas pois queria ter v√°rias sub-classes ligeiramente diferentes. Desisti porque n√£o d√° para fazer classes OS abstractas. Pena. Se calhar faz sentido n√£o dar, mas precisava mesmo. Se calhar ainda bem que n√£o escolhi OS porque nesse caso a performance era muito importante! Abra√ßo, Nuno
  ABAP da Depress√£o (28/09/2012 20:58): Grande Nuno! Eu at√© tive curiosidade sobre esse livro de OS, mas agora tenho certeza que n√£o vou aplicar essa t√©cnica em mais nenhum desenvolvimento antes da SAP anunciar corre√ß√µes. A quest√£o da abstra√ß√£o seria interessante, s√≥ que eu achei o help nesse assunto muito convoluto e, partindo dos resultados da implementa√ß√£o simples, n√£o tenho vontade de tentar usar OS com heran√ßa ou polimorfismo, ou mesmo sem üôÅ
    Nuno Godinho (30/09/2012 20:40): Embora o livro defenda a utiliza√ß√£o daquilo, e apresenta (oferecendo a implementa√ß√£o) uma solu√ß√£o para a quest√£o da falta de bloqueios. N√£o vi em detalhe, mas fiquei com a sensa√ß√£o de √© uma solu√ß√£o fita-cola.
    Nuno Godinho (30/09/2012 20:40): Embora o livro defenda a utiliza√ß√£o daquilo, e apresenta (oferecendo a implementa√ß√£o) uma solu√ß√£o para a quest√£o da falta de bloqueios. N√£o vi em detalhe, mas fiquei com a sensa√ß√£o de √© uma solu√ß√£o fita-cola.
  ABAP da Depress√£o (28/09/2012 20:58): Grande Nuno! Eu at√© tive curiosidade sobre esse livro de OS, mas agora tenho certeza que n√£o vou aplicar essa t√©cnica em mais nenhum desenvolvimento antes da SAP anunciar corre√ß√µes. A quest√£o da abstra√ß√£o seria interessante, s√≥ que eu achei o help nesse assunto muito convoluto e, partindo dos resultados da implementa√ß√£o simples, n√£o tenho vontade de tentar usar OS com heran√ßa ou polimorfismo, ou mesmo sem üôÅ
    Nuno Godinho (30/09/2012 20:40): Embora o livro defenda a utiliza√ß√£o daquilo, e apresenta (oferecendo a implementa√ß√£o) uma solu√ß√£o para a quest√£o da falta de bloqueios. N√£o vi em detalhe, mas fiquei com a sensa√ß√£o de √© uma solu√ß√£o fita-cola.
    Nuno Godinho (30/09/2012 20:40): Embora o livro defenda a utiliza√ß√£o daquilo, e apresenta (oferecendo a implementa√ß√£o) uma solu√ß√£o para a quest√£o da falta de bloqueios. N√£o vi em detalhe, mas fiquei com a sensa√ß√£o de √© uma solu√ß√£o fita-cola.
Mauricio Cruz (27/09/2012 15:24): ‚ÄúO servi√ßo de persist√™ncia n√£o √© realmente persistente, porque n√£o existe bloqueio de objetos transientes‚Äù Zuado. Sem mais‚Ä¶
Fawcs (26/09/2012 11:13): acho que deveria a amostra de testes deveria ter N >1000 e calcular o desvio padr√£o e m√©dia.
  ABAP da Depress√£o (26/09/2012 18:56): Nossa equipe de consultores off-shore altamente especializados est√° analisando o seu requerimento e responder√° em breve ao seu chamado. Atenciosamente, Equipe ABAPZombie Consultoria SAP Ltda.
    Mauricio Cruz (27/09/2012 14:12): Senhor Fawcs, Analisamos o seu requerimento e descobrimos que ele pertence a outra √°rea. Estamos redirecionando o chamado para o site ABAP101.com . Atenciosamente, Mauricio Cruz Membro da Equipe ABAPZombie Consultoria SAP Ltda.
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
    Mauricio Cruz (27/09/2012 14:12): Senhor Fawcs, Analisamos o seu requerimento e descobrimos que ele pertence a outra √°rea. Estamos redirecionando o chamado para o site ABAP101.com . Atenciosamente, Mauricio Cruz Membro da Equipe ABAPZombie Consultoria SAP Ltda.
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
  ABAP da Depress√£o (26/09/2012 18:56): Nossa equipe de consultores off-shore altamente especializados est√° analisando o seu requerimento e responder√° em breve ao seu chamado. Atenciosamente, Equipe ABAPZombie Consultoria SAP Ltda.
    Mauricio Cruz (27/09/2012 14:12): Senhor Fawcs, Analisamos o seu requerimento e descobrimos que ele pertence a outra √°rea. Estamos redirecionando o chamado para o site ABAP101.com . Atenciosamente, Mauricio Cruz Membro da Equipe ABAPZombie Consultoria SAP Ltda.
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
    Mauricio Cruz (27/09/2012 14:12): Senhor Fawcs, Analisamos o seu requerimento e descobrimos que ele pertence a outra √°rea. Estamos redirecionando o chamado para o site ABAP101.com . Atenciosamente, Mauricio Cruz Membro da Equipe ABAPZombie Consultoria SAP Ltda.
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P
      Lauffer (27/09/2012 17:56): Manda o .nugg pra ele fazer os c√°lculos todos e gerar gr√°ficos no excel, pq user gosta √© de ver tudo no excel mesmo  =P