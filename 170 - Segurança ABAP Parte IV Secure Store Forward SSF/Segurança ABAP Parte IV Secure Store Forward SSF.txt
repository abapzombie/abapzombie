Seguran√ßa ABAP ‚Äì Parte IV ‚Äì Secure Store & Forward (SSF)
Autor: Leo Schmidt
Data: 28/03/2013 09:00

O qu√™? Post novo da s√©rie de Seguran√ßa? O MUNDO ACABOU???
N√ÉO, CARO AMIGO ZUMBIZ√ìIDE! C√° estamos n√≥s de volta (eu no caso), dessa vez pra falar da parte que talvez √© a mais complexa, por√©m a que eu achei mais divertida, do mundinho de seguran√ßa ABAP: os mecanismos de assinatura digital e criptografia que podem ser usados atrav√©s da interface de seguran√ßa do SAP,
Secure Store & Forward
(BC-SEC-SSF)
, que chamarei apenas de SSF.
AQUI MORTO VIVO N√ÉO PASSA N√ÉO T√Å PENSANDO QUE √â O QUE
Antes de mais nada‚Ñ¢
Em primeiro lugar, √© importante ficar claro aqui que
n√£o existe API de¬†criptografia implementada puramente em
ABAP
. Procurando no SCN, aparecem
centenas de resultados
que indicam centenas de fun√ß√µes e classes como ‚Äúsolu√ß√µes‚Äù para criptografar dados em ABAP. Eis algumas delas:
FIEB_PASSWORD_ENCRYPT
ENCODE_SLDPWD_BASE64
HTTP_SCRAMBLE
OFX_ALS_PASSWORD_ENCRYPT
K_ENCRYPT_RESOURCE
SSFS_ENCODE_TEXT
SSFC_BASE64_ENCODE
MAKE_PASSWORD_UNREADABLE
CL_BSP_UTILITY=>ENCODE_STRING
CL_HARD_WIRED_ENCRYPTOR
m√©todos ENCODE* da interface IF_HTTP_UTILITY
Fu√ßando no Google eu achei inclusive
um projeto no Google Code
onde o cara implementou o algoritmo RSA em ABAP para usar com
strings
de c√≥digos ASCII. Essas ‚Äúsolu√ß√µes‚Äù, por mais que pare√ßam boas, tem pelo menos um dos seguintes problemas:
o algoritmo de criptografia n√£o atende padr√µes regulat√≥rios (PKCS, IETF, ASN.1, leis internacionais de prote√ß√£o da informa√ß√£o, etc.);
o algoritmo n√£o √© de criptografia de chave p√∫blica;
n√£o est√° sendo usado nenhum algoritmo de encripta√ß√£o, mas sim de codifica√ß√£o (Base64, UTF-8, etc.).
Entendendo o SSF
Antes de sair pulando pro c√≥digo, √© bom entender como funciona a
f√≠sica qu√¢ntica
infraestrutura por tr√°s da SSF.
O prop√≥sito do SSF √©
proteger documentos dentro do SAP
atrav√©s de
assinaturas digitais
e
envelopes digitais
. N√£o vou explicar nesse post como funcionam os mecanismos da criptografia, mesmo porque s√£o coisas que podem ser aprendidas facilmente na Wikipedia (principalmente
fun√ß√µes de hash (ingl√™s)
,
algoritmos de chave sim√©trica (ingl√™s)
,
criptografia de chave p√∫blica (ingl√™s)
,
infraestrutura de chaves p√∫blicas (ingl√™s)
), por√©m cabe definir aqui¬†de maneira geral como esses processos funcionam
para o SAP
.
Assinatura digital
√© o processo de autentica√ß√£o de documentos digitais que ocorre da seguinte maneira:
O autor de um documento calcula o
hash code
do mesmo e encripta esse c√≥digo resultante usando sua chave privada;
Ent√£o, o autor anexa o c√≥digo criptografado ao documento original¬†(‚Äúassina‚Äù o documento) e essa mensagem √© enviada ao destinat√°rio;
O destinat√°rio recebe a mensagem e tamb√©m calcula o
hash code
do documento original (com o mesmo algoritmo de
hash
usado pelo autor);
O destinat√°rio
desencripta o trecho ‚Äúassinado‚Äù da mensagem¬†usando a chave p√∫blica do autor, obtendo assim o
hash code
que foi calculado inicialmente pelo autor;
Finalmente, o destinat√°rio compara os dois c√≥digos obtidos. Se forem diferentes, isso significa que a) a mensagem foi alterada ap√≥s ser assinada ou b) a assinatura n√£o foi gerada com a chave privada correspondente √† chave p√∫blica usada na desencripta√ß√£o.
J√° os
envelopes digitais
funcionam de maneira semelhante, por√©m ‚Äúao contr√°rio‚Äù. A ideia aqui √© proteger um documento usando criptografia h√≠brida para que apenas o destinat√°rio possa visualiz√°-lo, da seguinte maneira:
O autor encripta o documento original usando um algoritmo de criptografia sim√©trica;
O autor anexa a chave da criptografia sim√©trica ao documento criptografado e encripta todo esse conte√∫do novamente, mas dessa vez usando a chave p√∫blica do destinat√°rio, e envia a mensagem;
O destinat√°rio recebe a mensagem, desencripta-a usando sua chave privada, e desencripta o documento usando a chave sim√©trica inclusa.
A fun√ß√£o da SSF √© a mesma da
Virus Scan Interface
(que eu abordei no
post anterior dessa s√©rie
):¬†o ECC em si n√£o prov√™ os servi√ßos, mas fornece a interface para um produto externo, que deve ser escolhido entre os¬†fornecidos por parceiros certificados pela SAP.
Toda instala√ß√£o do ECC (inclusive as vers√µes
trial
) j√° vem com um provedor de servi√ßos¬†padr√£o
apenas para a assinatura digital do servidor de aplica√ß√£o
, que √© chamado de SAP
Security Library
(SAPSECULIB). Se voc√™ pretende usar servi√ßos de criptografia ou de assinatura digital mais abrangentes, voc√™ deve usar um produto externo. A SAP disponibiliza para download gratuito no¬†Marketplace¬†uma biblioteca de servi√ßos de criptografia chamada SAP
Cryptographic Library
(SAPCRYPTOLIB) ‚Äì por√©m, esta biblioteca est√° sujeita √†s leis de exporta√ß√£o de tecnologia criptogr√°fica da Alemanha e sendo assim n√£o est√° dispon√≠vel para todos os clientes. A SAPCRYPTOLIB cont√©m, al√©m de algoritmos de criptografia, todas as fun√ß√µes j√° dispon√≠veis na SAPSECULIB.
Dependendo do produto externo que for usado, teremos uma infraestrutura de chaves p√∫blicas diferente. Quando lidamos com SAPSECULIB / SAPCRYPTOLIB, as informa√ß√µes de chave p√∫blica e privada do servidor ficam guardadas em arquivos chamados de
Personal Security Environments
(PSEs). Em instala√ß√µes de outros produtos que utilizem
smart cards
, por exemplo, a informa√ß√£o de chave privada do usu√°rio ficaria dentro do
smart card
, enquanto a informa√ß√£o de chave p√∫blica ficaria dispon√≠vel no servidor de aplica√ß√£o.
OK, mas cad√™ o c√≥digo?
Pra saber como usar as fun√ß√µes do SSF, o melhor √© consultar o
SSF
Programmer‚Äôs Guide
(obviamente em ingl√™s). As fun√ß√µes est√£o no grupo SSFG e as principais s√£o as seguintes:
SSF_SIGN / SSF_KRN_SIGN: servem para assinar um documento com uma chave privada;
SSF_VERIFY / SSF_KRN_VERIFY: servem para verificar uma assinatura em um documento;
SSF_ENVELOPE / SSF_KRN_ENVELOPE: criam um envelope digital com um documento;
SSF_DEVELOPE / SSF_KRN_DEVELOPE: decodificam um envelope digital.
As fun√ß√µes SSF_* utilizam destinos RFC, enquanto as fun√ß√µes SSF_KRN_* executam comandos diretamente no
kernel
e portanto s√£o mais r√°pidas.
Quando √© necess√°ria a interven√ß√£o do usu√°rio, algumas fun√ß√µes do SSF exibem telas espec√≠ficas para entrada de usu√°rio e senha, exibi√ß√£o do texto que ser√° assinado,¬†sele√ß√£o de arquivo com a chave privada, etc.
Assim como acontece com a
Virus Scan Interface
, o Basis tem o trabalho maior de configurar todo o ambiente da SSF e passar os par√¢metros para que as fun√ß√µes ABAP possam ser usadas.
Deu um trabalho¬†NERVOSO, mas eu consegui configurar o SSF na minha instala√ß√£o
trial
do Netweaver e testar as fun√ß√µes. Infelizmente eu n√£o consegui configurar assinaturas / envelopes para usu√°rios espec√≠ficos, mas pelo menos foi poss√≠vel usar assinaturas e envelopes do servidor. Depois de instalado, √© poss√≠vel testar as fun√ß√µes e configura√ß√µes nos
reports
SSF01 e SSF02.
Esse √© o SSF02, mesma coisa que o SSF01 s√≥ que com menos par√¢metros preenchidos
Para fazer os testes, eu criei um arquivo .TXT com o seguinte conte√∫do:
ABAP Zombie
Prevenindo Consultores de Virarem Zumbis
Vamos ver primeiro o resultado do
Signing
:
Sign (on application server)

Input data: 53

ABAP Zombie..Prevenindo Consultores de Virarem Zumbis

User profile (sign and develope)

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SAPSSLS.pse

Time: 19 ms

Result: SSF_API_OK

Results for the signatory:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SSF_API_SIGNER_OR_RECIPIENT_OK

Output data: 492

0#.#..*#H##....##.#0#.#...1.0...*#H##.....0D..*#H##....#7.5ABAP Zombie..Prevenindo Consultores de Virarem Zumbis1#.x0#.t...0t0i1.0...U....DE1.0...U....SAP Trust Community1.0...U.#Y0...*#H##....1...*#H##....0...*#H##....1...130327123728Z0...*#H##....1...Q##K#U.#..#M#US0...*#H##.......###N#A#.#g.nD#c.pv###MrE###K#3.### #.^8*#;#.$##.##F###KR.##G.##.###..v#G
Aqui ainda √© poss√≠vel ver o conte√∫do original do documento, por√©m acrescido da informa√ß√£o gerada pela assinatura com a chave privada do servidor.
Logo ap√≥s o
Signing
, √© poss√≠vel executar o
Verify
com os dados obtidos:
Verify (on application server)

Input data: 492

0#.#..*#H##....##.#0#.#...1.0...*#H##.....0D..*#H##....#7.5ABAP Zombie..Prevenindo Consultores de Virarem Zumbis1#.x0#.t...0t0i1.0...U....DE1.0...U....SAP Trust Community1.0...U.#Y0...*#H##....1...*#H##....0...*#H##....1...130327123728Z0...*#H##....1...Q##K#U.#..#M#US0...*#H##.......###N#A#.#g.nD#c.pv###MrE###K#3.### #.^8*#;#.$##.##F###KR.##G.##.###..v#G

Address Book for Signatory:

SAPSSLS.pse

Time: 5 ms

Result: SSF_API_OK

Results of the digital signature check:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SigningTime= Wed Mar 27 09:37:28 2013 (UTCTime: 130327123728Z)
SSF_API_SIGNER_OR_RECIPIENT_OK

Output data: 53

ABAP Zombie..Prevenindo Consultores de Virarem Zumbis
Aqui vemos a informa√ß√£o de volta ao formato original e sabemos que a assinatura do servidor e o documento est√£o corretos devido ao retorno SSF_API_SIGNER_OR_RECIPIENT_OK da fun√ß√£o.
Vamos tentar agora o
Envelope
:
Envelope (on application server)

Input data: 53

ABAP Zombie..Prevenindo Consultores de Virarem Zumbis

Recipient:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE

Private address book (verify and envelope)

SAPSSLS.pse

Time: 8 ms

Result: SSF_API_OK

Results for recipients:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SSF_API_SIGNER_OR_RECIPIENT_OK

Output data: 391

0#.#..*#H##....##.t0#.p...1#..0#.....0t0i1.0...U....DE1.0...U....SAP Trust Community1.0...U....SAP Web AS1.0...U....IDEMOSYSTEM1.0...U....nwabapxp.. ....(10...*#H##.......###X#..## =#LZy#r###&Y8.##.[.##B#Dt#D3#+#:d#Uw.G7####0X..*#H##....0...+......##.##$.##8xM.#Ap##pQ7#G##&.#.#]###.#..+I###.,##y####Z#.T#N#Y#.................
Aqui n√£o √© poss√≠vel identificar a informa√ß√£o original, que est√° encriptada com o algoritmo sim√©trico e com a chave p√∫blica do destinat√°rio (que nesse caso √© o pr√≥prio autor, o servidor).
Logo ap√≥s a execu√ß√£o do
Envelope
, o programa j√° mostra o resultado do
Develope
:
Develope (on application server)

Input data: 391

0#.#..*#H##....##.t0#.p...1#..0#.....0t0i1.0...U....DE1.0...U....SAP Trust Community1.0...U....SAP Web AS1.0...U....IDEMOSYSTEM1.0...U....nwabapxp.. ....(10...*#H##.......###X#..## =#LZy#r###&Y8.##.[.##B#Dt#D3#+#:d#Uw.G7####0X..*#H##....0...+......##.##$.##8xM.#Ap##pQ7#G##&.#.#]###.#..+I###.,##y####Z#.T#N#Y#.................

Develope for:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SAPSSLS.pse

Time: 9 ms

Result: SSF_API_OK

Results for recipients:

CN=nwabapxp, OU=IDEMOSYSTEM, OU=SAP Web AS, O=SAP Trust Community, C=DE
SSF_API_SIGNER_OR_RECIPIENT_OK

Output data: 53

ABAP Zombie..Prevenindo Consultores de Virarem Zumbis
E aqui temos a informa√ß√£o original desencriptada de volta.
Os padr√µes usados nestes testes s√£o:
PKCS7 para a sintaxe da mensagem gerada,
RSA para a criptografia de chave p√∫blica,
DES-CBC para a criptografia sim√©trica, e
SHA1 para o hash.
√â isso que eu tinha pra falar sobre SSF. Estou deixando muitos detalhes de fora, como instala√ß√£o, configura√ß√£o, certificados, mas tudo isso tem mais a ver com Basis do que com ABAP, e d√° pra conferir isso tudo no pr√≥prio
help
da SAP¬†sobre o assunto
.
T√° confuso? Escrevi groselha? Faltou coisa? Manda um coment√°rio ou um email. At√© a pr√≥xima.



Coment√°rios:
Diogenes Kaue (11/06/2018 08:53): Bom dia Leo Schmidt, tudo bem ? Estou atualmente em uma consultoria SAP, tenho dois anos de desenvolvimento ABAP, recentemente a consultoria me pediu para procurar formas de proteger o c√≥digo que venho desenvolvendo nos clientes. Li em alguns post pela internet em que atrav√©s do trecho abaixo consigo deixar o c√≥digo invis√≠vel, para o editor contudo n√£o consigo dar manuten√ß√£o ap√≥s a utiliza√ß√£o do mesmo. ******************* *@#@@[SAP] ******************** Tem alguma sugest√£o para proteger o c√≥digo, criptografar ?
  Leo Schmidt (11/06/2018 10:31): Bom dia Diogenes, td certo cara! Valeu pelo contato! O teu caso √© bastante complicado. O que eu expus no post serve pra um caso muito espec√≠fico, que seria a criptografia de documentos dentro do pr√≥prio SAP. Pra c√≥digo fonte, eu acredito que n√£o tem uma solu√ß√£o de criptografia muito pr√°tica. O que eu consigo pensar no teu cen√°rio √© usar essa alternativa que vc mesmo mencionou, e armazenar o c√≥digo vis√≠vel numa c√≥pia do ambiente de DEV onde vc possa desenvolver livremente. Infelizmente teria um passo a mais, que seria transportar o c√≥digo desse sistema pro sistema do cliente e deix√°-lo invis√≠vel, mas acho que √© o pre√ßo a se pagar pra manter os direitos do c√≥digo. Abra√ßos!
  Leo Schmidt (11/06/2018 10:31): Bom dia Diogenes, td certo cara! Valeu pelo contato! O teu caso √© bastante complicado. O que eu expus no post serve pra um caso muito espec√≠fico, que seria a criptografia de documentos dentro do pr√≥prio SAP. Pra c√≥digo fonte, eu acredito que n√£o tem uma solu√ß√£o de criptografia muito pr√°tica. O que eu consigo pensar no teu cen√°rio √© usar essa alternativa que vc mesmo mencionou, e armazenar o c√≥digo vis√≠vel numa c√≥pia do ambiente de DEV onde vc possa desenvolver livremente. Infelizmente teria um passo a mais, que seria transportar o c√≥digo desse sistema pro sistema do cliente e deix√°-lo invis√≠vel, mas acho que √© o pre√ßo a se pagar pra manter os direitos do c√≥digo. Abra√ßos!
Luiz Guilherme Cerqueira Campos (23/09/2016 13:21): Boa tarde senhores, Primeiramente parab√©ns pelo post, show de bola, referente a algo t√£o incomum e que pouqu√≠ssimos ABAPers conhe√ßam ‚Äì por√©m, de extrema import√¢ncia. Estou com um requerimento onde fa√ßo uma chama http para utilizar um servi√ßo, consegui realizar. O problema √© que os dados que encorpam o JSON, s√£o dados sens√≠veis, precisamos criptografar este json com a chave p√∫blica disponibilizada pelo servi√ßo que consegue decifra-la pela chave privada. Importamos essa chave no PSE? Tentei importar o certificado com a chave, por√©m sem sucesso. Teria algum exemplo para nos ajudar? Atenciosamente,
  Leo Schmidt (23/09/2016 16:02): Ol√° Luiz, obrigado pelo elogio. Cara, pelo pouco que eu sei o procedimento seria isso mesmo: importar o certificado com a chave p√∫blica pela STRUST e ent√£o usar a SSF_ENVELOPE pra criptografar. Os programas que eu mencionei no post (SSF01 / SSF02) s√£o os melhores exemplos que eu posso te dar, porque eles demonstram tudo o que as fun√ß√µes de criptografia podem fazer. Sei que n√£o √© muito, mas espero que isso ajude. []s, Leo
  Leo Schmidt (23/09/2016 16:02): Ol√° Luiz, obrigado pelo elogio. Cara, pelo pouco que eu sei o procedimento seria isso mesmo: importar o certificado com a chave p√∫blica pela STRUST e ent√£o usar a SSF_ENVELOPE pra criptografar. Os programas que eu mencionei no post (SSF01 / SSF02) s√£o os melhores exemplos que eu posso te dar, porque eles demonstram tudo o que as fun√ß√µes de criptografia podem fazer. Sei que n√£o √© muito, mas espero que isso ajude. []s, Leo
Espindola (21/10/2014 08:44): Bom Dia Com rela√ß√£o ao seu guia de Criptografia. Sensacional muito bem detalhado. Consegui gerar a assinatura, por√©m a criptografia n√£o funcionou. Vc lembra quais parametros colocou ?? Obrigado Luiz
  Leo Schmidt (23/09/2016 16:13): Luiz, sinto muito por responder s√≥ agora, mas n√£o sei te dizer. Eu lembro vagamente de come√ßar pelo padr√£o da SSF02 e ir ajustando a execu√ß√£o com os par√¢metros at√© fazer funcionar. Mais uma vez, desculpe pela neglig√™ncia üôÅ Leo
  Leo Schmidt (23/09/2016 16:13): Luiz, sinto muito por responder s√≥ agora, mas n√£o sei te dizer. Eu lembro vagamente de come√ßar pelo padr√£o da SSF02 e ir ajustando a execu√ß√£o com os par√¢metros at√© fazer funcionar. Mais uma vez, desculpe pela neglig√™ncia üôÅ Leo