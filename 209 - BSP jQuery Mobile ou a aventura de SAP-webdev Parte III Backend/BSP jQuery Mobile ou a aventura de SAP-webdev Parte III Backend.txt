BSP + jQuery Mobile, ou a aventura de SAP-webdev ‚Äì Parte III: Backend
Autor: Leo Schmidt
Data: 24/06/2015 10:00

Acho que n√£o demorou tanto quanto a saga do Freeza, mas sim caros zumbis, chegamos ao final desse guia! Vou falar agora¬†da parte principal do desenvolvimento: a aplica√ß√£o¬†BSP. Aqui vou mostrar como estruturar os recursos no
backend
e tamb√©m como ele vai responder a tudo o que acontece no
frontend
.
‚Ä¶mas antes, um pouco mais de
frontend
Lembra,¬†l√°¬†primeira parte, quando¬†eu disse que √© necess√°rio subir as bibliotecas de jQuery e jQuery Mobile e os
plugins
no reposit√≥rio MIME do SAP? Ent√£o, se voc√™ fez o
frontend
fora da SE80, √© bem prov√°vel que o¬†c√≥digo¬†que voc√™ fez ainda n√£o esteja referenciando as bibliotecas que est√£o¬†no reposit√≥rio. Os seus
headers
podem¬†estar mais ou menos assim:
<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <!-- outros scripts, plugins e stylesheets v√£o aqui -->
    </head>
    <body>
        <!-- resto da p√°gina aqui -->
    </body>
</html>
O endere√ßo da aplica√ß√£o BSP, na maioria das vezes, vai ser algo como
http://[servidor]:[porta]/sap/bc/bsp/[namespace]/[aplica√ß√£o]
. Aproveitando essa estrutura, podemos referenciar de maneira indireta as bibliotecas que est√£o dispon√≠veis globalmente. Por exemplo, se voc√™ tiver organizado as bibliotecas no reposit√≥rio MIME mais ou menos com a mesma estrutura do CDN do jQuery, desse jeito:
Voc√™ consegue mudar as declara√ß√µes acima por algo assim (os endere√ßos sempre s√£o
case insensitive
):
<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../public/jquery/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
        <script src="../public/jquery/jquery-1.11.3.min.js"></script>
        <script src="../public/jquery/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <!-- outros scripts, plugins e stylesheets v√£o aqui -->
    </head>
    <body>
        <!-- resto da p√°gina aqui -->
    </body>
</html>
E agora eu posso finalmente explicar o porqu√™ de usar o reposit√≥rio MIME e fazer essas mudan√ßas no
header
: √© pra atender a pol√≠tica de seguran√ßa dos navegadores que se chama
same-origin policy
(pol√≠tica de mesma origem). Isso serve tanto para
views
que voc√™ vai usar no BSP como para as que voc√™ definiu nos m√©todos da classe de
login
.
Outro detalhe que d√° pra perceber pela imagem e pelo c√≥digo: uma pr√°tica comum em desenvolvimento
web
√© fazer vers√µes
minified
(minimizadas ou comprimidas) de todos os arquivos que comp√µem as p√°ginas, com o mesmo nome mais a extens√£o
.min.[extens√£o original]
, de modo que a aplica√ß√£o trafegue uma quantidade menor de dados entre servidor e navegador. Em tempo de desenvolvimento ou de
debug
, referencia-se o arquivo original, e depois que tudo estiver pronto, comprimimos e mudamos as refer√™ncias para apontar para os arquivos comprimidos.¬†O Sublime Text, que eu indiquei no
post
anterior, tem alguns
packages
que fazem isso, como por exemplo o
Minify
(para a gl√≥ria da obviedade!), que comprime¬†JavaScript e CSS. Eu n√£o achei ainda nenhum
package
bacana pra minimizar HTML no Sublime, ent√£o eu uso ferramentas
on-line
mesmo como o
HTML Minifier
.
Estruturando a aplica√ß√£o
Eu pensei em colar aqui uma imagem com o famoso diagrama do MVC, mas eu n√£o sabia qual escolher:
Tem at√© um com o Homer ali
Vamos tentar o segundo ali mesmo:
O fluxo representado por esse diagrama √© basicamente o que a aplica√ß√£o BSP deve fazer:
Usu√°rio envia uma
request
HTTP ao
controller
;
Controller
requisita dados do
model
;
A resposta depende do conte√∫do: se a
request
foi comum, pedindo por uma
v
iew
, a aplica√ß√£o a instancia e esta¬†√© exibida¬†ao usu√°rio; se a
request
foi feita via Ajax, os¬†dados interpretados s√£o¬†devolvidos diretamente do
controller
para a
view
pela
response
, que ent√£o os interpreta e exibe o resultado ao usu√°rio.
Dessa maneira, uma¬†aplica√ß√£o BSP mais b√°sica que use jQuery / jQuery Mobile ser√° composta de uma classe para o
controller
e¬†uma classe para o
model
. A
view
n√£o precisa necessariamente de uma classe pr√≥pria, porque a ideia √© que a manipula√ß√£o da
view
seja feita atrav√©s dos
scripts
inseridos na p√°gina, sem interven√ß√£o ABAP ‚Äì mas se voc√™ tiver que montar HTML muito complexo ou de maneira muito frequente dentro dos m√©todos do
controller
(vou falar sobre isso mais pra baixo), talvez seja melhor ter uma classe que fa√ßa somente isso.¬†Essa estrutura pode ser repetida quantas vezes forem necess√°rias;¬†se a l√≥gica de tratamento das
requests
/
responses
ou da sele√ß√£o dos dados √© suficientemente complicada para que haja separa√ß√£o em mais
controllers
ou
models
, esse √© o caminho.
‚ÄúMas Leo, eu posso escrever tudo direto num
controller
s√≥! Pra qu√™ eu vou criar trocentas¬†classes s√≥ pra UMA¬†aplica√ß√£o?‚Äù Porque eu espero que voc√™ vai ser uma pessoa boa e seguir a arquitetura MVC. Afinal, voc√™ n√£o quer deixar um ninho de rato em forma de classe pra quem for dar manuten√ß√£o na aplica√ß√£o depois, certo? CERTO? Bom ent√£o.
A estrutura do BSP, usando a arquitetura
multipage
no
frontend
, ficaria mais ou menos assim:
Por partes, vamos.
Caracter√≠sticas da aplica√ß√£o
Nada muito complexo¬†por aqui:
Em
Initial
BSP
(‚ÄúBSP p√°gina inicial‚Äù) se indica o
nome do
controller
principal
da aplica√ß√£o;
Normalmente n√£o √© necess√°rio indicar uma
Application Class
(‚ÄúClasse de aplica√ß√£o‚Äù), mas se for necess√°rio segregar a l√≥gica da aplica√ß√£o da aplica√ß√£o em si, podemos indicar uma classe aqui, que pode ser acessada atrav√©s do atributo
APPLICATION
do
controller
;
N√£o √© necess√°rio indicar nada em
Theme
(‚ÄúTema‚Äù), porque carrega-se os temas diretamente pelo
markup
com as
tags
<link>
;
A quest√£o do estado da aplica√ß√£o √© aberta. √â poss√≠vel desenhar a aplica√ß√£o de maneira que n√£o se dependa de dados guardados no
model
, caso onde a op√ß√£o
Stateful
(‚ÄúCom status‚Äù) pode ficar desmarcada. Por√©m, se a aplica√ß√£o trata¬†uma quantidade muito grande de dados ou tem um fluxo l√≥gico muito complexo, √© melhor¬†manter estados e essa op√ß√£o precisaria¬†ficar marcada;
Supports Portal Integration
(‚ÄúSuporta integra√ß√£o Portal‚Äù) depende da sua aplica√ß√£o. A integra√ß√£o com o Portal geralmente tem a ver com navega√ß√£o e gerenciamento de sess√µes, parecido com o que acontece com aplica√ß√µes Webdynpro ABAP. Ative conforme necess√°rio;
XSRF
Protection
(‚ÄúProte√ß√£o XSRF‚Äù) √© a prote√ß√£o do
framework
BSP para prevenir
cross-site request forgery
.
Esta SAP
note
explica o que √© e como usar essa op√ß√£o.
Objetos MIME
Aqui √© onde se deve importar o c√≥digo espec√≠fico da sua
view
: o HTML descomprimido, os
scripts
comprimidos e descomprimidos, os
stylesheets
comprimidos e descomprimidos, e quaisquer outros objetos est√°ticos¬†espec√≠ficos para a sua aplica√ß√£o: logotipos, v√≠deos, √°udios, PDFs, etc. No HTML √© poss√≠vel¬†referenciar diretamente os objetos que voc√™ importar usando somente o¬†nome dos mesmos. O exemplo do cabe√ßalho que eu usei acima, ent√£o, ficaria:
<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="../public/jquery/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
        <script src="../public/jquery/jquery-1.11.3.min.js"></script>
        <script src="../public/jquery/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
        <!-- outros scripts, plugins e stylesheets v√£o aqui -->
        <link rel="stylesheet" href="style.min.css" />
        <script src="script.min.js"></script>
    </head>
    <body>
        <!-- resto da p√°gina aqui -->
    </body>
</html>
View
Aqui, tamb√©m, nada extraordin√°rio:
Observe, em primeiro lugar, que a
view
cont√©m o c√≥digo HTML
comprimido
, que ficar√° na aba
Layout
‚Äì portanto o nome
index.min.htm
. A p√°gina com o c√≥digo original descomprimido fica como objeto MIME do BSP, para futura refer√™ncia/manuten√ß√£o;
√â importante deixar o atributo
Compression
(‚ÄúComp.p√°ginas‚Äù) em branco (com o valor ‚Äú
None
‚Äù ou ‚Äúnenhuma‚Äù), porque os outros tipos de compress√£o podem afetar a sintaxe do HTML que j√° esteja minimizado;
O atributo
W/O Script Code
(‚Äúsem c√≥d.
script
‚Äú) deve ficar
desmarcado
, pois a p√°gina cont√©m
scripts
;
O
Page Type
(‚ÄúTipo de p√°gina‚Äù) √©
View
(‚ÄúVis√£o‚Äù), e voc√™ pode indicar qualquer
controller
ali¬†(contanto que a classe seja descendente¬†da
CL_BSP_CONTROLLER
‚Äì voc√™ pode inclusive indicar ela pr√≥pria);
Esta p√°gina n√£o ser√° uma p√°gina de erro (falei sobre elas na primeira parte da s√©rie), portanto o atributo
Is Error Page
fica
desmarcado
. Normalmente n√£o se atribui aqui uma p√°gina de erro espec√≠fica, pois as mensagens podem ser exibidas com outras t√©cnicas (que eu expliquei na segunda parte da s√©rie), por√©m em
Assigned Error Page
(‚ÄúP√°g.erro atribu√≠da‚Äù) voc√™ pode indicar uma outra p√°gina dentro da aplica√ß√£o que servir√° como p√°gina de erro;
Por fim,¬†mant√©m-se
desmarcado
o atributo
Delta Handling
(‚ÄúTratmto.delta‚Äù), porque n√£o queremos que o
framework
do BSP se intrometa na maneira como carregamos as p√°ginas da aplica√ß√£o.
Controller
Assim como nas outras p√°ginas de configura√ß√£o, nada muito estranho:
O nome do
controller
pode ser como voc√™ quiser, e n√£o precisa necessariamente terminar com
.do
. Para o
controller
principal √© comum usar
main
;
Em
Controller Class
(‚ÄúClasse controlador‚Äù) indica-se a classe criada para servir de
controller
da aplica√ß√£o. Esta classe deve ser descendente¬†da
CL_BSP_CONTROLLER
;
A op√ß√£o
Start
BSP
(‚ÄúBSP in√≠cio‚Äù) funciona em conjunto com a op√ß√£o¬†XSRF
Protection
da aplica√ß√£o, portanto veja a nota que eu mencionei mais acima para entender como us√°-la;
As op√ß√µes de p√°gina de erro funcionam aqui da mesma maneira que funcionam na
view
;
Com rela√ß√£o ao estado, a¬†escolha aqui √© a mesma que foi feita para a caracter√≠stica da aplica√ß√£o em si, com a diferen√ßa que o estado do
controller
pode ser mantido (
stateful
) independentemente do estado da aplica√ß√£o;
O armazenamento em
cache
pode ter um tempo maior do que zero, mas isso funciona melhor em aplica√ß√µes
stateless
. Em aplica√ß√µes
stateful
as op√ß√µes de
Caching
podem ficar em zero mesmo;
Compression
(‚ÄúCompress√£o‚Äù) e
HTTPS
s√£o opcionais. A primeira¬†comprime a p√°gina antes de envi√°-la ao navegador, e a segunda trafega-a usando SSL;
Assim como na
view
, deixe desmarcada a op√ß√£o
Delta Handling
(‚ÄúTratmto.delta‚Äù).
Classe do
controller
Essa classe √© respons√°vel por receber, tratar e responder as
requests.
Como j√° falei algumas vezes aqui, essa classe precisa ser descendente da
CL_BSP_CONTROLLER
.
A ideia √© aproveitar o m√≠nimo dessa heran√ßa apenas para fazer com que o
controller
responda as
requests
, tanto as geradas pelo usu√°rio quanto as feitas via Ajax. Para isso, √© necess√°rio:
Redefinir e implementar o m√©todo
DO_INIT
.
A implementa√ß√£o desse¬†m√©todo tem uma fun√ß√£o muito simples, que √©
inicializar o(s)
model(s)
e guardar a refer√™ncia da inst√¢ncia.¬†Para isso, basta chamar o m√©todo
CREATE_MODEL
:
METHOD do_init.
  me->model ?= me->create_model(
      class_name = 'Z_MINHA_CLASSE_DO_MODEL'
      model_id   = 'MINHA_CLASSE_DO_MODEL'
  ).
ENDMETHOD.
(FINALMENTE chegamos no¬†ABAP, hein?) O par√¢metro
model_id
serve para encontrar a inst√¢ncia de
model
correta no atributo
M_MODELS
atrav√©s do m√©todo
GET_MODELS
. Se voc√™ vai trabalhar com apenas um
model
(como √© o caso desse exemplo), √© mais pr√°tico guardar a inst√¢ncia do
model
diretamente num atributo novo da classe, como esse
me->model
que eu usei no exemplo acima, que no caso¬†referencia a classe
Z_MINHA_CLASSE_DO_MODEL
.
Redefinir e implementar o m√©todo
DO_REQUEST
.
Essa √© a implementa√ß√£o principal. O fluxo √© basicamente como nesse exemplo aqui:
METHOD do_request.

  DATA: cdata        TYPE string,
        code         TYPE i,
        content_type TYPE string,
        form_fields  TYPE tihttpnvp,
        message_type TYPE sy-msgty,
        reason       TYPE string.

* Assim como para o model, temos um atributo separado na classe para
* guardar a inst√¢ncia da view. Usamos aqui esse atributo para saber se a
* view j√° foi chamada:

  IF me->view IS INITIAL.

*   A inst√¢ncia da view ainda est√° vazia, portanto faremos s√≥ a
*   inicializa√ß√£o e chamada da view:

    me->view = me->create_view( view_name = 'index.min.htm' ).
    me->call_view( me->view ).

  ELSE.

*   A inst√¢ncia da view, aqui, j√° existe, portanto sabemos que a request
*   s√≥ pode ter sido feita via Ajax. Lembram dos exemplos de request
*   Ajax do post sobre frontend? Eles tinham endere√ßos mais ou menos
*   assim:

*   main?action=algumaCoisa&...

*   Pois bem, esse atributo de URL chamado ACTION √© a chave para
*   entender a request. Ent√£o vamos busc√°-lo:

    CASE me->request->get_form_field_cs( 'action' ).

*     Uma request GET espera uma resposta com dados em algum formato
*     (HTML, JSON, XML, etc.) a partir de algum par√¢metro. Ent√£o podemos
*     ter um m√©todo que retorne somente os dados, como por exemplo:

      WHEN 'getMaterialDescription'. "GET

        cdata = me->get_material_description( me->request->get_form_field_cs( 'material_number' ) ).

      WHEN 'getUnitDescription'. "GET

        cdata = me->get_unit_description( me->request->get_form_field_cs( 'material_unit' ) ).

*     Se tivermos v√°rios par√¢metros, a interface do m√©todo muda um pouco:

      WHEN 'getMaterials'. "GET

        me->request->get_form_fields_cs(
          CHANGING
            fields = form_fields
        ).

        me->get_materials(
          EXPORTING
            im_form_fields  = form_fields
          IMPORTING
            ex_cdata        = cdata
            ex_content_type = content_type
            ex_message_type = message_type
        ).

*     WHEN 'get...'. "GET

*       cdata = me->get_...

*     J√° uma request POST pretende alterar dados a partir de par√¢metros
*     informados pelo usu√°rio. Os par√¢metros de uma request POST
*     normalmente s√£o enviados no corpo da request, codificados em
*     string da mesma maneira que seriam numa request GET - portanto
*     para l√™-los precisamos da ajuda da classe CL_HTTP_UTILITY. Como
*     retorno, normalmente temos uma mensagem.

      WHEN 'createGoodsMovement'. "POST

        me->create_goods_movement(
          EXPORTING
            im_form_fields  = cl_http_utility=>string_to_fields( me->request->get_cdata( ) )
          IMPORTING
            ex_cdata        = cdata
            ex_content_type = content_type
            ex_message_type = message_type
        ).

      WHEN 'saveInventoryCount'. "POST

        me->save_inventory_count(
          EXPORTING
            im_form_fields  = cl_http_utility=>string_to_fields( me->request->get_cdata( ) )
          IMPORTING
            ex_cdata        = cdata
            ex_content_type = content_type
            ex_message_type = message_type
        ).

*     WHEN 'set...'. "POST

*       me->set_...(

      WHEN OTHERS.

*       Neste caso temos uma request Ajax sem o atributo action, ou seja,
*       n√£o √© uma request Ajax leg√≠tima para a aplica√ß√£o. Isso pode
*       acontecer, por exemplo, quando o usu√°rio executa um refresh (F5)
*       na p√°gina. Portanto, sabemos que a view j√° est√° criada, e basta
*       cham√°-la novamente:

        me->call_view( me->view ).
        RETURN.

    ENDCASE.

*   Se o processamento da request Ajax resultou em erro, precisamos
*   informar um c√≥digo de erro na resposta para que o frontend a
*   interprete corretamente:

    IF message_type = 'E'.
      code   = 422. "Unprocessable Entity - RFC 4918
      reason = 'Erro ao processar a request'(e01).
    ELSE.
      code   = 200. "OK
      reason = 'OK'.
    ENDIF.

    me->response->set_status(
        code   = code
        reason = reason
    ).

*   Os m√©todos de Ajax do jQuery s√£o capazes de reconhecer
*   automaticamente o tipo do conte√∫do da resposta, mas podemos tornar
*   as coisas mais claras indicando explicitamente valores como
*   'application/json' ou 'application/xml', conforme o retorno do
*   handler:

    IF NOT content_type IS INITIAL.
      me->response->set_content_type( content_type ).
    ENDIF.

*   Por fim, anexamos o conte√∫do da resposta:

    IF NOT cdata IS INITIAL.
      me->response->set_cdata( cdata ).
    ENDIF.

  ENDIF.

ENDMETHOD.
‚ÄúU√© Leo, mas de onde veio esse c√≥digo 422 pra erro? N√£o √© pra usar o 500?‚Äù N√£o, porque 500 √© um c√≥digo gen√©rico pra dizer que aconteceu algum erro no servidor, e o
framework
do BSP j√° usa esse c√≥digo pra informar
dumps
, o que √© adequado. Os erros que acontecem j√° dentro dos
event handlers
na maioria das vezes s√£o provocados por
entradas mal-formadas
, por culpa do usu√°rio ou do processamento ABAP, e n√£o necessariamente por causa do servidor. Por isso o erro devolvido aqui fica melhor¬†na categoria 4xx (
client error
).
‚ÄúAh‚Ä¶ mas ent√£o porque n√£o usar logo o 400 ‚Äì
Bad request
mesmo?‚Äù Porque o problema n√£o √© com a
request
em si, mas sim¬†com os
dados contidos
(pra falar mais empolado, n√£o √© sint√°tico, √© sem√¢ntico). Por exemplo: se o c√≥digo do material n√£o existe, isso n√£o √© necessariamente um problema com a
request
, mas sim com o pr√≥prio c√≥digo que pode estar errado.
Eis um
post
explicando um pouco sobre isso.
Criar
event handlers
espec√≠ficos para cada
action
Ajax.
N√£o precisam ser
event handlers
reais no contexto de ABAP
Objects
, mas sim apenas m√©todos que respondem a cada
action
Ajax definida no
frontend
, como eu mostrei nesse √∫ltimo exemplo. O fluxo de cada m√©todo vai ser simples: interpreta-se os par√¢metros da
request
, transformando os dados conforme necess√°rio, chama-se o m√©todo do
model
que tratar√° os dados e formata-se a resposta a ser devolvida ao
DO_REQUEST
. No exemplo abaixo, temos um
event handler
que vai ao
model
buscar uma lista de materiais a partir do centro e do dep√≥sito:
METHOD get_materials.

  DATA: material              TYPE string,
        material_descriptions TYPE makt_tab,
        message_text          TYPE string,
        number                TYPE string,
        plant                 TYPE werks_d,
        storage_location      TYPE lgort_d.

  FIELD-SYMBOLS: <field>                TYPE ihttpnvp,
                 <material_description> TYPE makt.

* Antes de mais nada √© preciso traduzir a string de par√¢metros que vem
* da request para vari√°veis que podemos usar em ABAP. O material
* continua em string aqui porque a ideia √© que seja poss√≠vel buscar
* tanto pelo MATNR como pelo MAKTX

  LOOP AT im_form_fields ASSIGNING <field>.
    CASE <field>-name.
      WHEN 'number'.
        material = <field>-value.
      WHEN 'plant'.
        plant = to_upper( val = <field>-value ).
      WHEN 'storageLocation'.
        storage_location = to_upper( val = <field>-value ).
      WHEN OTHERS.
    ENDCASE.
  ENDLOOP.

* Chamamos o model:

  me->model->get_materials(
    EXPORTING
      im_material              = material
      im_plant                 = plant
      im_storage_location      = storage_location
    IMPORTING
      ex_material_descriptions = material_descriptions
      ex_message_text          = message_text
      ex_message_type          = ex_message_type
  ).

  IF ex_message_type IS INITIAL.

*   Se o model n√£o devolver nenhuma mensagem, montamos um JSON com os
*   dados:

    ex_cdata = |\{"materials":[|.

    LOOP AT material_descriptions ASSIGNING <material_description>.

      CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
        EXPORTING
          input  = <material_description>-matnr
        IMPORTING
          output = number.

      ex_cdata = |{ ex_cdata }\{| &
                   |"number":"{ number }",| &
                   |"description":"{ <material_description>-maktx }"|.

      IF sy-tabix < lines( material_descriptions ).
        ex_cdata = |{ ex_cdata }\},|.
      ELSE.
        ex_cdata = |{ ex_cdata }\}|.
      ENDIF.

    ENDLOOP.

    ex_cdata = |{ ex_cdata }]\}|.

    ex_content_type = 'application/json'.

  ELSE.

*   Caso contr√°rio, chamamos outro m√©todo para construir um HTML com um
*   popup para a mensagem:

    me->build_message_data(
      EXPORTING
        im_type         = ex_message_type
        im_text         = message_text
      importing
        ex_cdata        = ex_cdata
        ex_content_type = ex_content_type
    ).

  ENDIF.

ENDMETHOD.
O resultado desse m√©todo √© um objeto JSON contendo um
array
de objetos representando os registros da MAKT que correspondem √† busca feita pelo usu√°rio, ou um outro objeto JSON com o tipo e texto da mensagem que ser√° exibida em
popup
.
Existe um certo dilema sobre o tipo de conte√∫do que deve ser usado na resposta de uma
request
Ajax. √â melhor retornar JSON e montar a exibi√ß√£o pelo
script
, ou devolver HTML montado e somente integr√°-lo na p√°gina, tamb√©m pelo
script
? Essa decis√£o cabe ao¬†desenvolvedor, e pode sem problemas¬†resultar em implementa√ß√µes diferentes para cada m√©todo. No projeto que eu estou usando de exemplo, h√°¬†um pouco de ambas as t√©cnicas: alguns m√©todos devolvem HTML montado, outros devolvem JSON. A regra que eu uso √© a seguinte: se for simples montar o HTML pelo
script
, o m√©todo retorna JSON; caso contr√°rio, o m√©todo retorna o HTML j√° montado.
Classe do
model
Aqui √© onde acontece a ‚Äúm√°gica‚Äù, se por m√°gica entendermos o n√∫cleo do trabalho ABAP ‚Äì valida√ß√£o complexa das entradas, opera√ß√µes com o banco de dados,¬†chamadas de fun√ß√µes, etc. Esta classe precisa ser descendente da
CL_BSP_MODEL
, por√©m, para este tipo de uso, n√£o necessita da redefini√ß√£o de nenhum dos m√©todos herdados.
Se estivermos trabalhando com uma aplica√ß√£o
stateful
, os resultados das opera√ß√µes da aplica√ß√£o ficar√£o armazenados¬†em atributos dessa classe, e ser√° necess√°rio controlar em alguns pontos espec√≠ficos os valores desses atributos.¬†Por exemplo, uma tabela¬†que represente o¬†resultado¬†da busca de um relat√≥rio pode precisar ser limpa toda vez que se chama a p√°gina¬†do relat√≥rio, da mesma maneira que se faz com vari√°veis globais em um grupo de fun√ß√µes. Para isso √© necess√°rio¬†criar uma chamada Ajax na entrada de cada p√°gina, e tamb√©m m√©todos correspondentes no
controller
e no
model
para fazer a limpeza dos atributos.
√â bom lembrar tamb√©m que, numa aplica√ß√£o
stateful
, as
requests
Ajax que resultam em um estado intermedi√°rio (ou seja,
actions
do tipo
set*
que apenas gravam dados nos atributos do
model
)
tamb√©m
est√£o alterando dados no servidor
e portanto devem ser iniciadas com o m√©todo
POST
.
Esta classe¬†deve esperar par√¢metros de entrada em seus m√©todos com dados j√° convertidos para os tipos ABAP, o que deve ser feito anteriormente pelo
controller
. Da mesma forma, os dados gerados pelo processamento do
model
s√£o apenas retornados para o
controller
, que ser√° respons√°vel por format√°-los adequadamente e inclu√≠-los na resposta, conforme o exemplo de
event handler
que est√° acima ‚Äì portanto essa classe n√£o deve ser respons√°vel por montar HTML ou JSON. As mensagens, por exemplo, podem ser chamadas com o uso de
MESSAGE ‚Ä¶ INTO
e retornadas em uma
string
, retornando tamb√©m o valor de
SY-MSGTY
.
Assim chegamos ao fim desse guia maluco. Espero ter ajudado voc√™s a terem uma ideia de como usar tecnologias de
frontend
, e de como integrar isso com o BSP, e qual √© o papel de cada um numa aplica√ß√£o. N√£o √© a coisa mais nova em folha em termos de desenvolvimento
web
pra SAP, mas pra quem gosta de interface isso d√° um sabor diferente de WebDynpro ABAP e de SAP GUI. Espero que eu consiga mais pra frente fazer um guia espelho desse, usando Gateway e UI5, mas por enquanto √© isso.
D√∫vidas, reclama√ß√µes ou sugest√µes, favor entrar em contato com o departamento de coment√°rios abaixo ou via e-mail. At√© mais!



Coment√°rios:
Max (15/09/2015 15:55): Opa‚Ä¶blz cara‚Ä¶ ficou muito bom o post!! s√≥ tenho um problema na tela de login: ao trocar as referencias css e javascript para o endere√ßo local, √© requirida a autentica√ß√£o para o css e javascript?! se eu ignorar esta autentica√ß√£o, ele d√° ‚Äú401 Unauthorized‚Äù no cabe√ßalho de cada include.. se eu me autenticar, ele ignora a tela de login! Voc√™ poderia me ajudar?! vlw!
  Leo Schmidt (15/09/2015 16:35): Fala Max, valeu! Agora que vc falou, eu acabei testando aqui e tem esse problema mesmo. Realmente, n√£o d√° pra usar o mesmo caminho dos recursos na tela de login e na aplica√ß√£o em si. A solu√ß√£o, que no caso √© meio gambiarrenta, √© subir as bibliotecas de jQuery e jQuery Mobile TAMB√âM em outro diret√≥rio no reposit√≥rio. Um diret√≥rio p√∫blico que a tela de login consegue enxergar √© esse aqui: [host:porta]/sap/public/bc/ur Nesse diret√≥rio ficam as bibliotecas de Unified Rendering, que s√£o respons√°veis pelo layout da tela de login standard. Pode criar um diret√≥rio novo ali e subir tudo de jQuery que a tela de login vai conseguir exibir sem problema. Vou colocar essa informa√ß√£o nos posts. Valeu de novo!
    Max (17/09/2015 16:32): Vlw meu caro! Fiz isso e funcionou perfeitamente! estou utilizando o bootstrap, mas se aplica da mesma forma! Vlw a dica!
    Max (17/09/2015 16:32): Vlw meu caro! Fiz isso e funcionou perfeitamente! estou utilizando o bootstrap, mas se aplica da mesma forma! Vlw a dica!
  Leo Schmidt (15/09/2015 16:35): Fala Max, valeu! Agora que vc falou, eu acabei testando aqui e tem esse problema mesmo. Realmente, n√£o d√° pra usar o mesmo caminho dos recursos na tela de login e na aplica√ß√£o em si. A solu√ß√£o, que no caso √© meio gambiarrenta, √© subir as bibliotecas de jQuery e jQuery Mobile TAMB√âM em outro diret√≥rio no reposit√≥rio. Um diret√≥rio p√∫blico que a tela de login consegue enxergar √© esse aqui: [host:porta]/sap/public/bc/ur Nesse diret√≥rio ficam as bibliotecas de Unified Rendering, que s√£o respons√°veis pelo layout da tela de login standard. Pode criar um diret√≥rio novo ali e subir tudo de jQuery que a tela de login vai conseguir exibir sem problema. Vou colocar essa informa√ß√£o nos posts. Valeu de novo!
    Max (17/09/2015 16:32): Vlw meu caro! Fiz isso e funcionou perfeitamente! estou utilizando o bootstrap, mas se aplica da mesma forma! Vlw a dica!
    Max (17/09/2015 16:32): Vlw meu caro! Fiz isso e funcionou perfeitamente! estou utilizando o bootstrap, mas se aplica da mesma forma! Vlw a dica!
Mauricio Cruz (06/07/2015 09:39): Ficou animal! (s√≥ acabei de ler hoje haha). Tendo trabalho com voc√™ com bsps tempos atr√°s, √© muito legal ver quantas melhorias voc√™ fez da nossa singela arquitetura de primeira viagem, principalmente de performance (com a minificazizaca√ß√£o) e uso de JSONs üôÇ Parab√©ns e abs mano!
Flavio Furlan (25/06/2015 17:29): Muito interessante! Quando voc√™ fizer esse guia na SAPUI5 + Gateway estarei na primeira fila para pegar meu exemplar üôÇ Confesso que meu crit√©rio para escolha de qual diagrama MVC escolher foi o mesmo que o seu: http://abap101.com/2012/04/01/falsa-programacao-orientada-objetos/ Abra√ßos!